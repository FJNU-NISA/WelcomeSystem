<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NISA Welcome System - ç§¯åˆ†åˆ†å‘</title>
    <!-- å¼•å…¥é€šç”¨åŸºç¡€æ ·å¼ -->
    <link rel="stylesheet" href="/Pages/Common/css/base.css">
    <!-- å¼•å…¥ç§¯åˆ†åˆ†å‘é¡µé¢ä¸“ç”¨æ ·å¼ -->
    <link rel="stylesheet" href="/Pages/ModifyPoint/css/modifypoints.css">
    <!-- Font Awesome å›¾æ ‡åº“ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- ç»Ÿä¸€å¯¼èˆªæ å°†é€šè¿‡JavaScriptè‡ªåŠ¨æ’å…¥ -->
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="page-container">
        <div class="main-container">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="header-section">
                <h1><i class="fas fa-coins"></i> ç§¯åˆ†åˆ†å‘ç®¡ç†</h1>
            </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div id="loadingDiv" class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>åŠ è½½ä¸­...</span>
                </div>

                <!-- é”™è¯¯æç¤º -->
                <div id="errorDiv" class="error-message" style="display: none;"></div>

                <!-- ç§¯åˆ†åˆ†å‘åŠŸèƒ½ -->
                <div class="modify-points-container" id="modifyPointsContainer" style="display: none;">
                
                    <!-- ç”¨æˆ·é€‰æ‹©åŒºåŸŸ -->
                    <div class="action-panel">
                        <h3><i class="fas fa-user-plus"></i> é€‰æ‹©ç›®æ ‡ç”¨æˆ·</h3>
                        <div class="search-form">
                            <div class="input-group">
                                <input type="text" id="targetStuId" placeholder="è¯·è¾“å…¥å­¦å·" 
                                       class="form-input" onkeypress="handleEnterKey(event)">
                                <button onclick="loadUserInfo()" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                    æŸ¥è¯¢ç”¨æˆ·
                                </button>
                            </div>
                        </div>
                        
                        <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
                        <div id="userInfoDisplay" class="user-info-card" style="display: none;">
                            <div class="user-info-content">
                                <div class="user-avatar">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="user-details">
                                    <div class="user-id">å­¦å·: <span id="userStuId">-</span></div>
                                    <div class="user-points">å½“å‰ç§¯åˆ†: <span id="userPoints">0</span></div>
                                </div>
                                <div class="user-actions" id="userActions" style="display: none;">
                                    <button onclick="goBackToInfo()" class="btn btn-outline btn-sm">
                                        <i class="fas fa-arrow-left"></i>
                                        è¿”å›ä¿¡æ¯é¡µé¢
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å…³å¡ç§¯åˆ†åˆ†å‘åŒºåŸŸ -->
                    <div class="action-panel levels-section" id="levelsSection" style="display: none;">
                        <div class="panel-header">
                            <h3><i class="fas fa-trophy"></i> å…³å¡ç§¯åˆ†åˆ†å‘</h3>
                            <span class="permission-badge admin">ç®¡ç†å‘˜åŠŸèƒ½</span>
                        </div>
                        <div class="levels-grid" id="levelsGrid">
                            <!-- å…³å¡æŒ‰é’®å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰ç§¯åˆ†åˆ†å‘ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰ -->
                    <div class="action-panel custom-points-section" id="customPointsSection" style="display: none;">
                        <div class="panel-header">
                            <h3><i class="fas fa-edit"></i> è‡ªå®šä¹‰ç§¯åˆ†è°ƒæ•´</h3>
                            <span class="permission-badge super-admin" id="customPointsBadge">è¶…çº§ç®¡ç†å‘˜åŠŸèƒ½</span>
                        </div>
                        <form id="customPointsForm" class="points-form">
                            <div class="form-grid">
                                <div class="form-field">
                                    <label for="customPoints">ç§¯åˆ†æ•°é‡</label>
                                    <input type="number" id="customPoints" name="points" 
                                           class="form-input" placeholder="æ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°å‡å°‘" required>
                                </div>
                                <div class="form-field">
                                    <label for="customReason">è°ƒæ•´åŸå› </label>
                                    <input type="text" id="customReason" name="reason" 
                                           class="form-input" placeholder="è¯·è¾“å…¥è°ƒæ•´åŸå› " required>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check"></i>
                                    ç¡®è®¤è°ƒæ•´
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- æ“ä½œå†å² -->
                    <div class="action-panel history-section">
                        <div class="panel-header">
                            <h3><i class="fas fa-history"></i> æœ€è¿‘æ“ä½œè®°å½•</h3>
                            <button class="btn btn-outline" onclick="refreshHistory()">
                                <i class="fas fa-sync-alt"></i>
                                åˆ·æ–°è®°å½•
                            </button>
                        </div>
                        <div id="historyContainer" class="history-list">
                            <div class="no-data">
                                <i class="fas fa-inbox"></i>
                                <p>æš‚æ— æ“ä½œè®°å½•</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤ºæ¨¡æ€æ¡† -->
    <div class="modal" id="messageModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">
                <h3 id="modalTitle">æç¤º</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <p id="modalMessage">æ¶ˆæ¯å†…å®¹</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="/Pages/Common/js/utils.js"></script>
    <script src="/Pages/Common/js/navigation.js"></script>
    <script>
        let currentUser = null;
        let levelsData = [];
        let currentTargetUser = null;
        let operationHistory = [];

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            initializePage();
        });

        // å¤‡ç”¨æ–¹æ¡ˆï¼šåœ¨window.onloadæ—¶ä¹Ÿå°è¯•åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('ğŸŒ WindowåŠ è½½å®Œæˆ');
            // å¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼ˆæ¯”å¦‚DOMContentLoadedæ²¡æœ‰è§¦å‘ï¼‰ï¼Œåˆ™å†æ¬¡å°è¯•
            if (!currentUser) {
                console.log('ğŸ”„ DOMContentLoadedå¯èƒ½æ²¡æœ‰è§¦å‘ï¼Œé‡æ–°åˆå§‹åŒ–...');
                initializePage();
            }
        });

        // åˆå§‹åŒ–é¡µé¢
        async function initializePage() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–ç§¯åˆ†åˆ†å‘é¡µé¢...');
            
            await checkAuth();
            if (currentUser) {
                console.log('âœ… ç”¨æˆ·è®¤è¯æˆåŠŸï¼Œå½“å‰ç”¨æˆ·:', currentUser);
                
                setupEventListeners();
                setupPermissions();
                
                // å…ˆæ£€æŸ¥URLå‚æ•°ï¼Œå†åŠ è½½å…³å¡æ•°æ®
                checkUrlParameters();
                await loadLevels();
                
                // åŠ è½½æ“ä½œå†å²
                refreshHistory();
                
                console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            }
        }

        // æ£€æŸ¥URLå‚æ•°ï¼Œæ”¯æŒä»å…¶ä»–é¡µé¢ä¼ é€’å­¦å·
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const stuId = urlParams.get('stuId');
            
            console.log('ğŸ” æ£€æŸ¥URLå‚æ•°:', window.location.search);
            console.log('ğŸ” è·å–åˆ°çš„stuId:', stuId);
            
            if (stuId && stuId.trim()) {
                console.log(`ğŸ¯ ä»ä¿¡æ¯æŸ¥è¯¢é¡µé¢è·å–åˆ°ç›®æ ‡å­¦å·: ${stuId}`);
                
                const targetInput = document.getElementById('targetStuId');
                if (targetInput) {
                    targetInput.value = stuId.trim();
                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    targetInput.style.borderColor = '#007bff';
                    targetInput.style.backgroundColor = '#f0f8ff';
                    
                    console.log('âœ… å·²è®¾ç½®å­¦å·åˆ°è¾“å…¥æ¡†:', targetInput.value);
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°ç›®æ ‡å­¦å·è¾“å…¥æ¡†å…ƒç´ ');
                }
                
                // è‡ªåŠ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯
                console.log('â³ å‡†å¤‡è‡ªåŠ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...');
                setTimeout(() => {
                    console.log('ğŸš€ å¼€å§‹è‡ªåŠ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯');
                    loadUserInfo();
                }, 800); // å¢åŠ å»¶è¿Ÿæ—¶é—´ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
            } else {
                console.log('â„¹ï¸ URLä¸­æ²¡æœ‰stuIdå‚æ•°æˆ–å‚æ•°ä¸ºç©º');
            }
        }

        // æ£€æŸ¥ç”¨æˆ·æƒé™
        async function checkAuth() {
            try {
                const response = await fetch('/api/user/info', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.status === 401) {
                    // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                    window.location.href = '/login';
                    return;
                }

                if (!response.ok) {
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }

                const data = await response.json();
                
                // APIç›´æ¥è¿”å›ç”¨æˆ·å¯¹è±¡ï¼Œä¸æ˜¯åŒ…è£…æ ¼å¼
                currentUser = data;
                
                // æ£€æŸ¥æƒé™ï¼šåªæœ‰ç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®
                if (currentUser.role !== 'admin' && currentUser.role !== 'super_admin') {
                    showModal('æƒé™ä¸è¶³', 'åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ­¤é¡µé¢', 'error');
                    setTimeout(() => {
                        window.location.href = '/info';
                    }, 2000);
                    return;
                }
                
                displayUserInfo();
            } catch (error) {
                console.error('æƒé™æ£€æŸ¥é”™è¯¯:', error);
                showError('æƒé™éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } finally {
                document.getElementById('loadingDiv').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function displayUserInfo() {
            document.getElementById('modifyPointsContainer').style.display = 'block';
        }

        // è®¾ç½®æƒé™æ ‡è¯†
        function setupPermissions() {
            // è¶…çº§ç®¡ç†å‘˜æ‰èƒ½çœ‹åˆ°è‡ªå®šä¹‰ç§¯åˆ†åˆ†å‘åŠŸèƒ½
            if (currentUser.role === 'super_admin') {
                document.getElementById('customPointsSection').style.display = 'block';
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // è‡ªå®šä¹‰ç§¯åˆ†åˆ†å‘è¡¨å•
            document.getElementById('customPointsForm').addEventListener('submit', handleCustomPoints);
        }

        // å¤„ç†å›è½¦é”®
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                loadUserInfo();
            }
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            const targetInput = document.getElementById('targetStuId');
            const stuId = targetInput ? targetInput.value.trim() : '';
            
            console.log('ğŸ“‹ å¼€å§‹åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œå­¦å·:', stuId);
            
            if (!stuId) {
                console.warn('âš ï¸ å­¦å·ä¸ºç©º');
                showModal('æç¤º', 'è¯·è¾“å…¥å­¦å·', 'warning');
                return;
            }

            try {
                console.log('ğŸŒ å‘é€APIè¯·æ±‚:', `/api/user/info?stuId=${stuId}`);
                
                const response = await fetch(`/api/user/info?stuId=${stuId}`, {
                    credentials: 'include'
                });

                console.log('ğŸ“¨ APIå“åº”çŠ¶æ€:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… ç”¨æˆ·ä¿¡æ¯åŠ è½½æˆåŠŸ:', data);
                    
                    // APIç›´æ¥è¿”å›ç”¨æˆ·å¯¹è±¡
                    currentTargetUser = data;
                    displayTargetUserInfo();
                    document.getElementById('levelsSection').style.display = 'block';
                    
                    // é‡æ–°ç”Ÿæˆå…³å¡æŒ‰é’®ä»¥åæ˜ ç”¨æˆ·çš„å®ŒæˆçŠ¶æ€
                    generateLevelButtons();
                    
                    console.log('ğŸ‰ ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºå®Œæˆ');
                } else if (response.status === 404) {
                    console.warn('âŒ ç”¨æˆ·ä¸å­˜åœ¨:', stuId);
                    showModal('ç”¨æˆ·ä¸å­˜åœ¨', 'æœªæ‰¾åˆ°è¯¥å­¦å·å¯¹åº”çš„ç”¨æˆ·', 'error');
                    hideUserSections();
                } else {
                    console.error('âŒ APIå“åº”é”™è¯¯:', response.status, response.statusText);
                    throw new Error(`æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                showModal('é”™è¯¯', 'æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                hideUserSections();
            }
        }

        // æ˜¾ç¤ºç›®æ ‡ç”¨æˆ·ä¿¡æ¯
        function displayTargetUserInfo() {
            document.getElementById('userStuId').textContent = currentTargetUser.stuId;
            document.getElementById('userPoints').textContent = currentTargetUser.points || 0;
            document.getElementById('userInfoDisplay').style.display = 'block';
            
            // æ£€æŸ¥æ˜¯å¦ä»ä¿¡æ¯é¡µé¢è·³è½¬è¿‡æ¥ï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºè¿”å›æŒ‰é’®
            const urlParams = new URLSearchParams(window.location.search);
            const fromInfoPage = urlParams.get('stuId'); // å¦‚æœURLä¸­æœ‰stuIdå‚æ•°ï¼Œè¯´æ˜æ˜¯ä»ä¿¡æ¯é¡µé¢è·³è½¬è¿‡æ¥çš„
            const userActions = document.getElementById('userActions');
            
            if (fromInfoPage && userActions) {
                userActions.style.display = 'flex';
                console.log('ğŸ”— æ˜¾ç¤ºè¿”å›ä¿¡æ¯é¡µé¢æŒ‰é’®');
            } else if (userActions) {
                userActions.style.display = 'none';
            }
        }

        // éšè—ç”¨æˆ·ç›¸å…³åŒºåŸŸ
        function hideUserSections() {
            document.getElementById('userInfoDisplay').style.display = 'none';
            document.getElementById('levelsSection').style.display = 'none';
            currentTargetUser = null;
        }

        // åŠ è½½å…³å¡æ•°æ®
        async function loadLevels() {
            try {
                const response = await fetch('/api/levels/all', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        levelsData = data.levels;
                        generateLevelButtons();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å…³å¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // ç”Ÿæˆå…³å¡æŒ‰é’®
        function generateLevelButtons() {
            const levelsGrid = document.getElementById('levelsGrid');
            levelsGrid.innerHTML = '';

            if (levelsData.length === 0) {
                levelsGrid.innerHTML = '<div class="no-data"><i class="fas fa-layer-group"></i><p>æš‚æ— å…³å¡æ•°æ®</p></div>';
                return;
            }

            // åªæ˜¾ç¤ºå·²æ¿€æ´»çš„å…³å¡
            const activeLevels = levelsData.filter(level => level.isActive);
            
            if (activeLevels.length === 0) {
                levelsGrid.innerHTML = '<div class="no-data"><i class="fas fa-layer-group"></i><p>æš‚æ— å·²æ¿€æ´»çš„å…³å¡</p></div>';
                return;
            }

            // è·å–ç›®æ ‡ç”¨æˆ·çš„å®Œæˆå…³å¡åˆ—è¡¨
            const completedLevels = currentTargetUser ? (currentTargetUser.completedLevels || []) : [];

            activeLevels.forEach(level => {
                const isCompleted = completedLevels.includes(level._id);
                const levelCard = document.createElement('div');
                
                // æ ¹æ®å®ŒæˆçŠ¶æ€æ·»åŠ ä¸åŒçš„CSSç±»
                levelCard.className = isCompleted ? 'level-card level-completed' : 'level-card';
                
                // æ ¹æ®å®ŒæˆçŠ¶æ€æ˜¾ç¤ºä¸åŒçš„å†…å®¹
                const buttonClass = isCompleted ? 'btn btn-secondary level-award-btn disabled' : 'btn btn-success level-award-btn';
                const buttonText = isCompleted ? 'å·²å®Œæˆ' : 'å®Œæˆå…³å¡';
                const buttonIcon = isCompleted ? 'fas fa-check' : 'fas fa-trophy';
                const buttonDisabled = isCompleted ? 'disabled' : '';
                const buttonOnClick = isCompleted ? '' : `onclick="awardLevelPoints('${level._id}')"`;
                
                levelCard.innerHTML = `
                    <div class="level-name">${level.name}</div>
                    <div class="level-points">+${level.points} ç§¯åˆ†</div>
                    <div class="level-description">${level.description || 'å®Œæˆæ­¤å…³å¡è·å¾—ç§¯åˆ†å¥–åŠ±'}</div>
                    ${isCompleted ? '<div class="level-completed-badge"><i class="fas fa-crown"></i> å·²å®Œæˆ</div>' : ''}
                    <button class="${buttonClass}" ${buttonDisabled} ${buttonOnClick}>
                        <i class="${buttonIcon}"></i>
                        ${buttonText}
                    </button>
                `;
                levelsGrid.appendChild(levelCard);
            });
        }

        // å¥–åŠ±å…³å¡ç§¯åˆ†
        async function awardLevelPoints(levelId) {
            if (!currentTargetUser) {
                showModal('æç¤º', 'è¯·å…ˆé€‰æ‹©ç›®æ ‡ç”¨æˆ·', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/points/level', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        stuId: currentTargetUser.stuId,
                        levelId: levelId
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showModal('æˆåŠŸ', data.message || 'å…³å¡ç§¯åˆ†åˆ†å‘æˆåŠŸ', 'success');
                    // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯ä»¥æ›´æ–°ç§¯åˆ†
                    await loadUserInfo();
                    refreshHistory();
                } else {
                    showModal('å¤±è´¥', data.detail || data.message || 'å…³å¡ç§¯åˆ†åˆ†å‘å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ†å‘å…³å¡ç§¯åˆ†å¤±è´¥:', error);
                showModal('é”™è¯¯', 'åˆ†å‘å…³å¡ç§¯åˆ†å¤±è´¥', 'error');
            }
        }

        // å¤„ç†è‡ªå®šä¹‰ç§¯åˆ†åˆ†å‘
        async function handleCustomPoints(event) {
            event.preventDefault();
            
            if (!currentTargetUser) {
                showModal('æç¤º', 'è¯·å…ˆé€‰æ‹©ç›®æ ‡ç”¨æˆ·', 'warning');
                return;
            }

            const formData = new FormData(event.target);
            const points = parseInt(formData.get('points'));
            const reason = formData.get('reason');

            if (isNaN(points) || !reason.trim()) {
                showModal('æç¤º', 'è¯·å¡«å†™å®Œæ•´çš„ç§¯åˆ†ä¿¡æ¯', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/points/modify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        stuId: currentTargetUser.stuId,
                        points: points,
                        reason: reason
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showModal('æˆåŠŸ', data.message || 'è‡ªå®šä¹‰ç§¯åˆ†åˆ†å‘æˆåŠŸ', 'success');
                    // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯ä»¥æ›´æ–°ç§¯åˆ†
                    await loadUserInfo();
                    // æ¸…ç©ºè¡¨å•
                    event.target.reset();
                    refreshHistory();
                } else {
                    showModal('å¤±è´¥', data.detail || data.message || 'è‡ªå®šä¹‰ç§¯åˆ†åˆ†å‘å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ†å‘è‡ªå®šä¹‰ç§¯åˆ†å¤±è´¥:', error);
                showModal('é”™è¯¯', 'åˆ†å‘è‡ªå®šä¹‰ç§¯åˆ†å¤±è´¥', 'error');
            }
        }

        // åˆ·æ–°æ“ä½œå†å²
        async function refreshHistory() {
            const container = document.getElementById('historyContainer');
            
            // å¦‚æœæ²¡æœ‰é€‰æ‹©ç”¨æˆ·ï¼Œæ˜¾ç¤ºæç¤º
            if (!currentTargetUser) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-info-circle"></i>
                        <p>è¯·å…ˆé€‰æ‹©ç›®æ ‡ç”¨æˆ·</p>
                    </div>
                `;
                return;
            }
            
            try {
                // è·å–æŒ‡å®šç”¨æˆ·çš„æ“ä½œå†å²
                const response = await fetch(`/api/points/history/${encodeURIComponent(currentTargetUser.stuId)}?limit=20`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('è·å–å†å²è®°å½•å¤±è´¥');
                }
                
                const data = await response.json();
                
                if (data.history && data.history.length > 0) {
                    // ç”Ÿæˆå†å²è®°å½•HTML
                    const historyHTML = data.history.map(record => {
                        // æ ¹æ®ç±»å‹è®¾ç½®å›¾æ ‡
                        let icon;
                        let typeText;
                        
                        switch(record.type) {
                            case 'level_completion':
                                icon = '<i class="fas fa-trophy" style="color: #ffc107;"></i>';
                                typeText = 'å…³å¡å®Œæˆ';
                                break;
                            case 'manual_modify':
                                icon = '<i class="fas fa-edit" style="color: #007bff;"></i>';
                                typeText = 'æ‰‹åŠ¨è°ƒæ•´';
                                break;
                            case 'lottery_draw':
                                icon = '<i class="fas fa-gift" style="color: #dc3545;"></i>';
                                typeText = 'æŠ½å¥–æ¶ˆè€—';
                                break;
                            case 'revoke':
                                icon = '<i class="fas fa-undo" style="color: #6c757d;"></i>';
                                typeText = 'æ“ä½œæ’¤é”€';
                                break;
                            default:
                                icon = '<i class="fas fa-coins" style="color: #28a745;"></i>';
                                typeText = 'å…¶ä»–æ“ä½œ';
                        }
                        
                        const pointsChange = record.pointsChange || 0;
                        const pointsColor = pointsChange > 0 ? 'text-success' : 'text-danger';
                        const pointsSign = pointsChange > 0 ? '+' : '';
                        
                        // åˆ¤æ–­æ˜¯å¦å·²è¢«æ’¤é”€
                        const isRevoked = record.revoked || false;
                        const revokedClass = isRevoked ? 'revoked-record' : '';
                        
                        // åˆ¤æ–­æ˜¯å¦å¯ä»¥æ’¤é”€/æ¢å¤
                        // æœªè¢«æ’¤é”€çš„è®°å½•å¯ä»¥æ’¤é”€
                        // æ’¤é”€æ“ä½œæœ¬èº«(type=revoke)å¦‚æœæœªè¢«æ’¤é”€,ä¹Ÿå¯ä»¥è¢«æ’¤é”€(å³æ¢å¤åŸè®°å½•)
                        const canRevoke = !isRevoked;
                        
                        // ç¡®å®šæŒ‰é’®æ–‡æœ¬å’Œæ ·å¼
                        const isRevokeType = record.type === 'revoke';
                        const actionBtnText = isRevokeType ? 'æ¢å¤' : 'æ’¤é”€';
                        const actionBtnClass = isRevokeType ? 'btn-info' : 'btn-warning';
                        const actionBtnIcon = isRevokeType ? 'fa-redo' : 'fa-undo';
                        
                        return `
                            <div class="history-item ${revokedClass}" data-record-id="${record.recordId}">
                                <div class="history-icon">${icon}</div>
                                <div class="history-details">
                                    <div class="history-main">
                                        <span class="history-type">${typeText}</span>
                                        <span class="history-points ${pointsColor}">${pointsSign}${pointsChange}ç§¯åˆ†</span>
                                        ${isRevoked ? '<span class="revoked-badge"><i class="fas fa-ban"></i> å·²æ’¤é”€</span>' : ''}
                                    </div>
                                    <div class="history-sub">
                                        <span class="history-reason">${record.reason || 'æ— è¯´æ˜'}</span>
                                        <span class="history-time"><i class="fas fa-clock"></i> ${record.formatted_time || 'æœªçŸ¥æ—¶é—´'}</span>
                                        ${record.operator ? `<span class="history-operator"><i class="fas fa-user"></i> ${record.operator}</span>` : ''}
                                    </div>
                                    ${isRevoked && record.revokedBy ? `
                                        <div class="history-revoke-info">
                                            <i class="fas fa-info-circle"></i> 
                                            ç”± ${record.revokedBy} äº ${formatDateTime(record.revokedAt)} æ’¤é”€
                                        </div>
                                    ` : ''}
                                </div>
                                ${canRevoke ? `
                                    <div class="history-actions">
                                        <button class="btn btn-sm ${actionBtnClass}" onclick="revokePointOperation('${currentTargetUser.stuId}', '${record.recordId}', ${isRevokeType})">
                                            <i class="fas ${actionBtnIcon}"></i> ${actionBtnText}
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    container.innerHTML = historyHTML;
                } else {
                    container.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-inbox"></i>
                            <p>æš‚æ— æ“ä½œè®°å½•</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('è·å–æ“ä½œå†å²å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle text-danger"></i>
                        <p>åŠ è½½å†å²è®°å½•å¤±è´¥</p>
                    </div>
                `;
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateTimeValue) {
            if (!dateTimeValue) return 'æœªçŸ¥';
            
            try {
                let date;
                if (dateTimeValue.$date) {
                    date = new Date(dateTimeValue.$date);
                } else if (typeof dateTimeValue === 'string') {
                    date = new Date(dateTimeValue);
                } else if (dateTimeValue instanceof Date) {
                    date = dateTimeValue;
                } else {
                    date = new Date(dateTimeValue);
                }
                
                if (isNaN(date.getTime())) {
                    return 'æ—¥æœŸæ ¼å¼é”™è¯¯';
                }
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (error) {
                console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', error);
                return 'æ—¥æœŸæ ¼å¼é”™è¯¯';
            }
        }

        // æ’¤é”€/æ¢å¤ç§¯åˆ†æ“ä½œ
        async function revokePointOperation(stuId, recordId, isRestore = false) {
            const actionText = isRestore ? 'æ¢å¤' : 'æ’¤é”€';
            const actionDesc = isRestore 
                ? 'æ¢å¤åå°†é‡æ–°åº”ç”¨ä¹‹å‰è¢«æ’¤é”€çš„ç§¯åˆ†å˜æ›´ã€‚' 
                : 'æ’¤é”€åå°†å›é€€ç›¸åº”çš„ç§¯åˆ†å˜æ›´ã€‚';
            
            if (!confirm(`ç¡®è®¤è¦${actionText}è¿™æ¡ç§¯åˆ†æ“ä½œå—ï¼Ÿ\n${actionDesc}`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/points/revoke/${encodeURIComponent(stuId)}/${encodeURIComponent(recordId)}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showModal('æˆåŠŸ', data.message || `æ“ä½œ${actionText}æˆåŠŸ`, 'success');
                    // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯å’Œå†å²è®°å½•
                    await loadUserInfo();
                    await refreshHistory();
                } else {
                    const error = await response.json();
                    showModal('å¤±è´¥', error.detail || `æ“ä½œ${actionText}å¤±è´¥`, 'error');
                }
            } catch (error) {
                console.error(`${actionText}æ“ä½œå¤±è´¥:`, error);
                showModal('é”™è¯¯', `${actionText}æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•`, 'error');
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(title, message, type = 'info') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            
            const modal = document.getElementById('messageModal');
            const modalHeader = document.getElementById('modalHeader');
            
            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
            modalHeader.className = `modal-header ${type}`;
            
            modal.style.display = 'flex';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        // è¿”å›ä¿¡æ¯é¡µé¢ï¼ˆå½“ä»ä¿¡æ¯é¡µé¢è·³è½¬è¿‡æ¥æ—¶ï¼‰
        function goBackToInfo() {
            const targetStuId = document.getElementById('targetStuId').value.trim();
            if (targetStuId) {
                // è¿”å›åˆ°æŒ‡å®šç”¨æˆ·çš„ä¿¡æ¯é¡µé¢
                window.location.href = `/info?stuId=${encodeURIComponent(targetStuId)}`;
            } else {
                // è¿”å›åˆ°è‡ªå·±çš„ä¿¡æ¯é¡µé¢
                window.location.href = '/info';
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('messageModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>