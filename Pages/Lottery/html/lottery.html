<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NISA Welcome System - æŠ½å¥–</title>
    <!-- å¼•å…¥é€šç”¨åŸºç¡€æ ·å¼ -->
    <link rel="stylesheet" href="/Pages/Common/css/base.css">
    <!-- å¼•å…¥æŠ½å¥–é¡µé¢ä¸“ç”¨æ ·å¼ -->
    <link rel="stylesheet" href="/Pages/Lottery/css/lottery.css?v=20251003_fix3">
    <!-- Font Awesome å›¾æ ‡åº“ -->
    <link href="/Pages/Common/libs/font-awesome/all.min.css" rel="stylesheet">
    
    <!-- å¼ºåˆ¶ä¿®å¤æŠ½å¥–æŒ‰é’®å‚ç›´å¸ƒå±€ -->
    <style>
        .lottery-button-area {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 2rem !important;
            width: 100% !important;
        }
        
        @media (max-width: 768px) {
            .lottery-button-area {
                gap: 1.5rem !important;
            }
            
            .user-points-display {
                width: 100% !important;
                max-width: 400px !important;
                background: rgba(255, 255, 255, 0.1) !important;
                backdrop-filter: blur(10px) !important;
                border-radius: 15px !important;
                border: 1px solid rgba(255, 255, 255, 0.2) !important;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1) !important;
                padding: 1rem 1.5rem !important;
            }
            
            .lottery-button-container {
                width: 100% !important;
                max-width: 400px !important;
                display: flex !important;
                justify-content: center !important;
            }
        }
        
        @media (max-width: 480px) {
            .lottery-button-area {
                gap: 1rem !important;
            }
            
            .user-points-display {
                max-width: 320px !important;
                padding: 0.8rem 1rem !important;
            }
            
            .lottery-button-container {
                max-width: 320px !important;
            }
            
            /* ä¿®å¤å¥–å“å¡ç‰‡æ˜¾ç¤º */
            .prize-card {
                height: auto !important;
                min-height: 140px !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .prize-info {
                padding: 0 !important;
                flex: 1 !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: space-between !important;
            }
            
            .prize-name {
                font-size: 0.75rem !important;
                line-height: 1.2 !important;
                margin-bottom: 0.2rem !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                display: -webkit-box !important;
                -webkit-line-clamp: 2 !important;
                -webkit-box-orient: vertical !important;
            }
            
            .prize-description {
                font-size: 0.7rem !important;
                line-height: 1.1 !important;
                margin-bottom: 0.3rem !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                display: -webkit-box !important;
                -webkit-line-clamp: 1 !important;
                -webkit-box-orient: vertical !important;
            }
            
            .prize-quantity {
                font-size: 0.7rem !important;
                margin-top: auto !important;
            }
        }
        
        @media (max-width: 768px) and (min-width: 481px) {
            /* ä¸­ç­‰å±å¹•å¥–å“å¡ç‰‡ä¼˜åŒ– */
            .prize-card {
                height: auto !important;
                min-height: 160px !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .prize-info {
                padding: 0 !important;
                flex: 1 !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: space-between !important;
            }
            
            .prize-name {
                font-size: 0.85rem !important;
                line-height: 1.2 !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                display: -webkit-box !important;
                -webkit-line-clamp: 2 !important;
                -webkit-box-orient: vertical !important;
            }
        }
    </style>
</head>
<body>
    <!-- ç»Ÿä¸€å¯¼èˆªæ å°†é€šè¿‡JavaScriptè‡ªåŠ¨æ’å…¥ -->
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="page-container">
        <main class="content-wrapper">
        <!-- å¥–å“å±•ç¤ºåŒº -->
        <section class="prizes-section">
            <!-- å¥–å“æ»šåŠ¨å±•ç¤º -->
            <div class="prizes-carousel">
                <div class="carousel-track" id="carouselTrack">
                    <div class="loading-prizes">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>åŠ è½½å¥–å“ä¸­...</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- æŠ½å¥–åŒºåŸŸ -->
        <section class="lottery-section">
            <div class="lottery-container">
                <!-- æŠ½å¥–æ“ä½œåŒº - å±…ä¸­å¸ƒå±€ -->
                <div class="lottery-action-area">
                    <div class="lottery-info-panel">
                        <h3><i class="fas fa-info-circle"></i> æŠ½å¥–è¯´æ˜</h3>
                        <ul>
                            <li>æ¯æ¬¡æŠ½å¥–æ¶ˆè€— <strong id="lotteryCostDisplay">1</strong> ç§¯åˆ†</li>
                            <li>å¥–å“æ•°é‡æœ‰é™ï¼Œå…ˆåˆ°å…ˆå¾—</li>
                            <li>æŠ½ä¸­å¥–å“åå¯åœ¨"ä¸ªäººä¿¡æ¯"ä¸­æŸ¥çœ‹</li>
                        </ul>
                    </div>
                    
                    <!-- æŠ½å¥–æŒ‰é’®å’Œç§¯åˆ†æ˜¾ç¤ºåŒºåŸŸ -->
                    <div class="lottery-button-area" style="display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; gap: 2rem !important; width: 100% !important;">
                        <!-- ç”¨æˆ·ç§¯åˆ†æ˜¾ç¤º -->
                        <div class="user-points-display" id="userPointsDisplay" style="display: none;">
                            <div class="points-info">
                                <span class="points-label">å½“å‰ç§¯åˆ†ï¼š</span>
                                <span id="currentPoints" class="points-value">0</span>
                            </div>
                        </div>
                        
                        <!-- æŠ½å¥–æŒ‰é’® -->
                        <div class="lottery-button-container">
                            <button class="lottery-btn" id="lotteryBtn" onclick="startLottery()">
                                <div class="btn-background"></div>
                                <div class="btn-content">
                                    <div class="btn-icon">
                                        <i class="fas fa-gift"></i>
                                    </div>
                                    <div class="btn-text-container">
                                        <span class="btn-main-text">å¼€å§‹æŠ½å¥–</span>
                                        <span class="btn-sub-text">æ¶ˆè€— <span id="lotteryCostInBtn">1</span> ç§¯åˆ†</span>
                                    </div>
                                </div>
                                <div class="btn-shine"></div>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </section>

    </main>

    <!-- æ¶ˆæ¯æç¤ºæ¨¡æ€æ¡† -->
    <div class="modal" id="messageModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">
                <h3 id="modalTitle">æç¤º</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <p id="modalMessage">æ¶ˆæ¯å†…å®¹</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="/Pages/Common/js/utils.js"></script>
    <script>
        let currentUser = null;
        let prizesData = [];
        let lotteryCost = 1; // é»˜è®¤å€¼è®¾ä¸ºé…ç½®æ–‡ä»¶ä¸­çš„å€¼
        let isDrawing = false;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // åˆå§‹åŒ–é¡µé¢
        async function initializePage() {
            await loadLotteryCost(); // é¦–å…ˆåŠ è½½æŠ½å¥–æˆæœ¬
            await checkUserLogin();
            await loadPrizes();
        }

        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        async function checkUserLogin() {
            try {
                console.log('ğŸ” å¼€å§‹æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€...');
                
                // æ£€æŸ¥æœ¬åœ°cookie
                const cookies = document.cookie;
                console.log('ğŸª å½“å‰cookies:', cookies);
                
                const response = await fetch('/api/user/status', {
                    method: 'GET',
                    credentials: 'include'
                });

                console.log('ğŸ“¡ ç”¨æˆ·çŠ¶æ€APIå“åº”çŠ¶æ€:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('ğŸ“‹ ç”¨æˆ·çŠ¶æ€APIå“åº”æ•°æ®:', data);
                    
                    if (data.success && data.logged_in && data.user) {
                        console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', data.user);
                        currentUser = data.user;
                        updateUserInterface(true);
                        return;
                    } else {
                        console.log('âŒ ç”¨æˆ·æœªç™»å½•æˆ–æ•°æ®æ— æ•ˆ:', data);
                    }
                } else {
                    console.log('âŒ ç”¨æˆ·çŠ¶æ€APIè¯·æ±‚å¤±è´¥:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('âŒ æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯:', error);
            }
            
            console.log('ğŸ“ è®¾ç½®ä¸ºæœªç™»å½•çŠ¶æ€');
            currentUser = null;
            updateUserInterface(false);
        }

        // æ›´æ–°ç”¨æˆ·ç•Œé¢
        function updateUserInterface(isLoggedIn) {
            const userInfo = document.getElementById('userInfo');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const profileBtn = document.getElementById('profileBtn');
            const userPointsDisplay = document.getElementById('userPointsDisplay');

            if (isLoggedIn && currentUser) {
                // å·²ç™»å½•çŠ¶æ€
                if (document.getElementById('userName')) {
                    document.getElementById('userName').textContent = currentUser.stuId;
                }
                if (document.getElementById('userPoints')) {
                    document.getElementById('userPoints').textContent = `${currentUser.points} ç§¯åˆ†`;
                }
                if (document.getElementById('currentPoints')) {
                    document.getElementById('currentPoints').textContent = currentUser.points;
                }
                
                if (userInfo) userInfo.style.display = 'inline';
                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'inline-block';
                if (profileBtn) profileBtn.style.display = 'inline-block';
                if (userPointsDisplay) userPointsDisplay.style.display = 'block';

                // æ›´æ–°æŠ½å¥–æŒ‰é’®çŠ¶æ€
                updateLotteryButton();
            } else {
                // æœªç™»å½•çŠ¶æ€
                if (userInfo) userInfo.style.display = 'none';
                if (loginBtn) loginBtn.style.display = 'inline-block';
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (profileBtn) profileBtn.style.display = 'none';
                if (userPointsDisplay) userPointsDisplay.style.display = 'none';

                // é‡ç½®æŠ½å¥–æŒ‰é’®
                resetLotteryButton();
            }
        }

        // åŠ è½½å¥–å“åˆ—è¡¨
        async function loadPrizes() {
            try {
                const response = await fetch('/api/lottery/prizes');
                const data = await response.json();
                
                if (data.success) {
                    prizesData = data.prizes;
                    displayPrizes(prizesData);
                } else {
                    showNoPrizes();
                }
            } catch (error) {
                console.error('åŠ è½½å¥–å“å¤±è´¥:', error);
                showNoPrizes();
            }
        }

        // æ˜¾ç¤ºå¥–å“
        function displayPrizes(prizes) {
            const track = document.getElementById('carouselTrack');
            
            if (!prizes || prizes.length === 0) {
                showNoPrizes();
                return;
            }

            // ç”Ÿæˆå¥–å“å¡ç‰‡HTML
            let html = '';
            prizes.forEach(prize => {
                // æ ¹æ®åº“å­˜é‡å†³å®šæ˜¾ç¤ºæ ·å¼
                const quantityClass = prize.quantity <= 0 ? 'out-of-stock' : '';
                const quantityText = prize.quantity <= 0 ? 'å·²æŠ½å®Œ' : `å‰©ä½™: ${prize.quantity}`;
                const quantityColor = prize.quantity <= 0 ? 'color: #e74c3c;' : 'color: #27ae60;';
                
                html += `
                    <div class="prize-card ${quantityClass}">
                        <div class="prize-image">
                            <img src="${prize.image || '/Assest/Prize/default.png'}" 
                                 alt="${prize.name}" 
                                 onerror="this.src='/Assest/Prize/default.png'">
                            ${prize.quantity <= 0 ? '<div class="sold-out-badge">å·²æŠ½å®Œ</div>' : ''}
                        </div>
                        <div class="prize-info">
                            <h3 class="prize-name">${prize.name}</h3>
                            <p class="prize-description">${prize.description || ''}</p>
                            <div class="prize-quantity" style="${quantityColor}">
                                <i class="fas fa-box"></i>
                                <span>${quantityText}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            // å…³é”®ï¼šå¤åˆ¶å¤šæ¬¡å¥–å“åˆ—è¡¨ç¡®ä¿æ— ç¼å¾ªç¯
            // å¤åˆ¶2ä»½å®Œå…¨ç›¸åŒçš„å†…å®¹ï¼Œè¿™æ ·å½“ç¬¬ä¸€ä»½æ»šåŠ¨å®Œï¼ˆ-50%ï¼‰æ—¶ï¼Œç¬¬äºŒä»½åˆšå¥½æ¥ä¸Š
            track.innerHTML = html + html;
            
            // é‡ç½®åŠ¨ç”»ä»¥ç¡®ä¿ä»å¤´å¼€å§‹
            track.style.animation = 'none';
            // å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜ï¼ˆè§¦å‘å›æµï¼‰
            void track.offsetWidth;
            // é‡æ–°åº”ç”¨åŠ¨ç”» - 15ç§’å®Œæˆä¸€ä¸ªå¾ªç¯ï¼Œé€Ÿåº¦æ›´å¿«
            track.style.animation = 'seamless-scroll 15s linear infinite';
            
            console.log(`âœ… å¥–å“å±•ç¤ºå·²åŠ è½½: ${prizes.length} ä¸ªå¥–å“ x 2 = ${prizes.length * 2} å¼ å¡ç‰‡`);
        }

        // æ˜¾ç¤ºæ— å¥–å“çŠ¶æ€
        function showNoPrizes() {
            const track = document.getElementById('carouselTrack');
            track.innerHTML = `
                <div class="no-prizes-message">
                    <i class="fas fa-gift"></i>
                    <p>æš‚æ— å¯æŠ½å¥–å“</p>
                </div>
            `;
        }

        // åŠ è½½æŠ½å¥–æ¶ˆè€—ç§¯åˆ†
        async function loadLotteryCost() {
            try {
                const response = await fetch('/api/lottery/cost');
                const data = await response.json();
                
                if (data.success) {
                    lotteryCost = data.cost;
                    // æ›´æ–°å„ä¸ªåœ°æ–¹çš„ç§¯åˆ†æ˜¾ç¤º
                    const costElements = ['lotteryCostInBtn', 'lotteryCostDisplay'];
                    costElements.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = lotteryCost;
                        }
                    });
                    
                    if (currentUser) {
                        updateLotteryButton();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æŠ½å¥–ç§¯åˆ†å¤±è´¥:', error);
            }
        }

        // å¼€å§‹æŠ½å¥–
        async function startLottery() {
            if (isDrawing) return;

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!currentUser) {
                showModal('éœ€è¦ç™»å½•', 'è¯·å…ˆç™»å½•åå†è¿›è¡ŒæŠ½å¥–', 'warning');
                return;
            }

            // æ£€æŸ¥æƒé™ï¼ˆåªæœ‰æ™®é€šç”¨æˆ·å¯ä»¥æŠ½å¥–ï¼‰
            if (currentUser.role !== 'user') {
                showModal('æƒé™ä¸è¶³', 'åªæœ‰æ™®é€šä¼šå‘˜å¯ä»¥å‚ä¸æŠ½å¥–', 'error');
                return;
            }

            // æ£€æŸ¥ç§¯åˆ†
            if (currentUser.points < lotteryCost) {
                showModal('ç§¯åˆ†ä¸è¶³', `æŠ½å¥–éœ€è¦ ${lotteryCost} ç§¯åˆ†ï¼Œæ‚¨å½“å‰åªæœ‰ ${currentUser.points} ç§¯åˆ†`, 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨å¥–å“
            if (!prizesData || prizesData.length === 0) {
                showModal('æš‚æ— å¥–å“', 'å½“å‰æ²¡æœ‰å¯æŠ½å¥–å“ï¼Œè¯·ç¨åå†è¯•', 'warning');
                return;
            }

            isDrawing = true;
            
            // æ˜¾ç¤ºæŠ½å¥–åŠ¨ç”»
            showLotteryAnimation();

            try {
                const response = await fetch('/api/lottery/draw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();
                
                console.log('ğŸ² æŠ½å¥–APIå“åº”:', data);
                
                if (response.ok && data.success) {
                    // æŠ½å¥–æˆåŠŸ - å»¶è¿Ÿæ˜¾ç¤ºç»“æœï¼Œç¡®ä¿ç”¨æˆ·çœ‹åˆ°"æŠ½å¥–ä¸­"çŠ¶æ€
                    setTimeout(() => {
                        hideLotteryAnimation();
                        showLotteryResult(data);
                    }, 500);
                    
                    // æ›´æ–°ç”¨æˆ·ç§¯åˆ† - å…¼å®¹é©¼å³°å’Œä¸‹åˆ’çº¿å‘½å
                    const remainingPoints = data.remainingPoints !== undefined ? data.remainingPoints : data.remaining_points;
                    if (remainingPoints !== undefined) {
                        currentUser.points = remainingPoints;
                        // ç«‹å³æ›´æ–°æ˜¾ç¤º
                        document.getElementById('currentPoints').textContent = remainingPoints;
                    }
                    updateUserInterface(true);
                    
                    // é‡æ–°åŠ è½½å¥–å“åˆ—è¡¨ï¼ˆæ›´æ–°åº“å­˜ï¼‰
                    await loadPrizes();
                } else {
                    setTimeout(() => {
                        hideLotteryAnimation();
                        showModal('æŠ½å¥–å¤±è´¥', data.detail || data.message || 'æŠ½å¥–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    }, 2000);
                }
            } catch (error) {
                console.error('æŠ½å¥–é”™è¯¯:', error);
                setTimeout(() => {
                    hideLotteryAnimation();
                    showModal('ç½‘ç»œé”™è¯¯', 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }, 2000);
            } finally {
                isDrawing = false;
            }
        }

        // æ˜¾ç¤ºæŠ½å¥–åŠ¨ç”»
        function showLotteryAnimation() {
            // ç¦ç”¨æŠ½å¥–æŒ‰é’®å¹¶æ˜¾ç¤º"æŠ½å¥–ä¸­..."
            const btn = document.getElementById('lotteryBtn');
            if (btn) {
                btn.classList.add('disabled');
                btn.disabled = true;
                const btnMainText = btn.querySelector('.btn-main-text');
                if (btnMainText) {
                    btnMainText.textContent = 'æŠ½å¥–ä¸­...';
                }
            }
        }

        // éšè—æŠ½å¥–åŠ¨ç”»
        function hideLotteryAnimation() {
            // æ¢å¤æŠ½å¥–æŒ‰é’®
            const btn = document.getElementById('lotteryBtn');
            if (btn) {
                btn.classList.remove('disabled');
                btn.disabled = false;
                updateLotteryButton();
            }
        }

        // æ˜¾ç¤ºæŠ½å¥–ç»“æœ
        function showLotteryResult(data) {
            console.log('ğŸ æ˜¾ç¤ºæŠ½å¥–ç»“æœ:', data);
            
            // è·å–å¥–å“æ•°æ®ï¼Œå¤„ç†å¯èƒ½çš„å‘½åå·®å¼‚
            const prize = data.prize || {};
            const prizeName = prize.name || 'æœªçŸ¥å¥–å“';
            let prizeImage = prize.image || prize.photo || '';
            
            // å¤„ç†å›¾ç‰‡è·¯å¾„ï¼šå¦‚æœåªæ˜¯æ–‡ä»¶åï¼Œæ·»åŠ å®Œæ•´è·¯å¾„
            if (prizeImage && !prizeImage.startsWith('http') && !prizeImage.startsWith('/')) {
                prizeImage = `/Assest/Prize/${prizeImage}`;
            }
            
            console.log('ğŸ–¼ï¸ å¥–å“å›¾ç‰‡è·¯å¾„:', prizeImage);
            
            // æ„å»ºåŒ…å«å¥–å“å›¾ç‰‡å’Œåç§°çš„HTMLå†…å®¹
            const prizeContent = `
                <div style="text-align: center; padding: 20px 0;">
                    ${prizeImage ? 
                        `<div style="margin-bottom: 20px;">
                            <img src="${prizeImage}" 
                                 alt="${prizeName}"
                                 style="max-width: 200px; max-height: 200px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"
                                 onerror="this.parentElement.innerHTML='<div style=\\'width: 200px; height: 200px; margin: 0 auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;\\'><i class=\\'fas fa-gift fa-4x\\'style=\\'color: white;\\'></i></div>'">
                         </div>` 
                        : `<div style="width: 200px; height: 200px; margin: 0 auto 20px auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                               <i class="fas fa-gift fa-4x" style="color: white;"></i>
                           </div>`
                    }
                    <h3 style="font-size: 1.5em; color: #333; margin: 10px 0; font-weight: bold;">
                        ${prizeName}
                    </h3>
                </div>
            `;
            
            // ä½¿ç”¨modalå±•ç¤ºæŠ½å¥–ç»“æœ
            showModal('ğŸ‰ æ­å–œä¸­å¥–ï¼', prizeContent, 'success');
            
            // æ›´æ–°ç”¨æˆ·ç§¯åˆ†æ˜¾ç¤º
            if (data.remainingPoints !== undefined || data.remaining_points !== undefined) {
                const remainingPoints = data.remainingPoints !== undefined ? data.remainingPoints : data.remaining_points;
                if (currentUser) {
                    currentUser.points = remainingPoints;
                    updatePointsDisplay();
                }
            }
        }
        
        // æ›´æ–°ç§¯åˆ†æ˜¾ç¤ºå‡½æ•°
        function updatePointsDisplay() {
            if (currentUser && currentUser.points !== undefined) {
                const pointsElement = document.getElementById('currentPoints');
                if (pointsElement) {
                    pointsElement.textContent = currentUser.points;
                }
                // åŒæ—¶æ›´æ–°æŠ½å¥–æŒ‰é’®çŠ¶æ€
                updateLotteryButton();
            }
        }

        // æ›´æ–°æŠ½å¥–æŒ‰é’®çŠ¶æ€
        function updateLotteryButton() {
            const btn = document.getElementById('lotteryBtn');
            if (!btn) return; // é˜²æ­¢ç©ºæŒ‡é’ˆé”™è¯¯
            
            const btnMainText = btn.querySelector('.btn-main-text');
            const btnSubText = btn.querySelector('.btn-sub-text');
            
            if (!btnMainText) return; // é˜²æ­¢ç©ºæŒ‡é’ˆé”™è¯¯
            
            if (!currentUser) {
                btnMainText.textContent = 'è¯·å…ˆç™»å½•';
                if (btnSubText) btnSubText.textContent = '';
                btn.classList.add('disabled');
                btn.disabled = true;
            } else if (currentUser.role !== 'user') {
                btnMainText.textContent = 'ä»…é™æ™®é€šä¼šå‘˜';
                if (btnSubText) btnSubText.textContent = '';
                btn.classList.add('disabled');
                btn.disabled = true;
            } else if (currentUser.points < lotteryCost) {
                btnMainText.textContent = 'ç§¯åˆ†ä¸è¶³';
                if (btnSubText) btnSubText.textContent = `éœ€è¦ ${lotteryCost} ç§¯åˆ†`;
                btn.classList.add('disabled');
                btn.disabled = true;
            } else {
                btnMainText.textContent = 'å¼€å§‹æŠ½å¥–';
                if (btnSubText) btnSubText.innerHTML = `æ¶ˆè€— <span id="lotteryCostInBtn">${lotteryCost}</span> ç§¯åˆ†`;
                btn.classList.remove('disabled');
                btn.disabled = false;
            }
        }

        // é‡ç½®æŠ½å¥–æŒ‰é’®
        function resetLotteryButton() {
            const btn = document.getElementById('lotteryBtn');
            if (!btn) return; // é˜²æ­¢ç©ºæŒ‡é’ˆé”™è¯¯
            
            const btnText = btn.querySelector('.btn-main-text');
            if (btnText) {
                btnText.textContent = 'è¯·å…ˆç™»å½•';
            }
            btn.classList.add('disabled');
            btn.disabled = true;
        }

        // è·³è½¬åˆ°ç™»å½•é¡µé¢
        function goToLogin() {
            window.location.href = '/login';
        }

        // ç™»å‡º
        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('ç™»å‡ºé”™è¯¯:', error);
            } finally {
                currentUser = null;
                updateUserInterface(false);
                showModal('ç™»å‡ºæˆåŠŸ', 'æ‚¨å·²æˆåŠŸç™»å‡º', 'success');
            }
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(title, message, type = 'info') {
            const modal = document.getElementById('messageModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalHeader = document.getElementById('modalHeader');
            const modalContent = modal.querySelector('.modal-content');
            
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            
            // è®¾ç½®æ¨¡æ€æ¡†æ ·å¼
            modalHeader.className = `modal-header ${type}`;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶æ·»åŠ åŠ¨ç”»
            modal.style.display = 'flex';
            modalContent.style.transform = 'scale(0.8)';
            modalContent.style.opacity = '0';
            
            // ä½¿ç”¨requestAnimationFrameç¡®ä¿æ ·å¼åº”ç”¨åå†å¼€å§‹åŠ¨ç”»
            requestAnimationFrame(() => {
                modalContent.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                modalContent.style.transform = 'scale(1)';
                modalContent.style.opacity = '1';
            });
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const modal = document.getElementById('messageModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
            modalContent.style.transform = 'scale(0.8)';
            modalContent.style.opacity = '0';
            
            setTimeout(() => {
                modal.style.display = 'none';
                modalContent.style.transition = '';
            }, 300);
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            if (!timestamp) return 'æœªçŸ¥æ—¶é—´';
            
            try {
                const date = new Date(timestamp);
                return date.toLocaleString('zh-CN');
            } catch (e) {
                return 'æœªçŸ¥æ—¶é—´';
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('messageModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
    
    <!-- å¼•å…¥ç»Ÿä¸€å¯¼èˆªæ ç»„ä»¶ -->
    <script src="/Pages/Common/js/navigation.js"></script>
</body>
</html>