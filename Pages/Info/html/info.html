<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NISA Welcome System - ä¸ªäººä¿¡æ¯</title>
    <!-- å¼•å…¥é€šç”¨åŸºç¡€æ ·å¼ -->
    <link rel="stylesheet" href="/Pages/Common/css/base.css">
    <!-- å¼•å…¥ä¸ªäººä¿¡æ¯é¡µé¢ä¸“ç”¨æ ·å¼ -->
    <link rel="stylesheet" href="/Pages/Info/css/info.css">
    <!-- Font Awesome å›¾æ ‡åº“ (æœ¬åœ°ç‰ˆæœ¬) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- å¯é çš„äºŒç»´ç ç”Ÿæˆåº“ -->
    <script src="/Pages/Common/js/libs/qrcode.min.js"></script>
    <script src="/Pages/Common/js/libs/simple-qr-generator.js"></script>
    <!-- äºŒç»´ç æ‰«æåº“ -->
    <script src="/Pages/Common/js/libs/jsQR.js"></script>
</head>
<body>
    <!-- ç»Ÿä¸€å¯¼èˆªæ å°†é€šè¿‡JavaScriptè‡ªåŠ¨æ’å…¥ -->
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="page-container">
        <div class="content-wrapper">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="page-header">
                <h2><i class="fas fa-user"></i> ä¸ªäººä¿¡æ¯</h2>
            </div>

            <!-- ç®¡ç†å‘˜æœç´¢åŠŸèƒ½ -->
            <div class="admin-search-section" id="adminSearchSection" style="display: none;">
                <div class="search-card">
                    <div class="search-header">
                        <h3><i class="fas fa-search"></i> ç”¨æˆ·æŸ¥è¯¢</h3>
                    </div>
                    <div class="search-body">
                        <div class="search-methods">
                            <div class="search-method">
                                <label for="stuIdInput">å­¦å·æŸ¥è¯¢ï¼š</label>
                                <div class="search-input-group">
                                    <input type="text" id="stuIdInput" placeholder="è¾“å…¥å­¦å·" />
                                    <button onclick="searchUserByStuId()" class="btn btn-primary">
                                        <i class="fas fa-search"></i> æŸ¥è¯¢
                                    </button>
                                </div>
                            </div>
                            <div class="search-method">
                                <label>äºŒç»´ç æ‰«æï¼š</label>
                                
                                <!-- æ–¹å¼1ï¼šä¸Šä¼ äºŒç»´ç å›¾ç‰‡ï¼ˆæ¨èï¼Œæ— éœ€æ‘„åƒå¤´ï¼‰ -->
                                <div class="scan-controls">
                                    <label for="qrImageUpload" class="btn btn-primary" style="margin-bottom: 10px; cursor: pointer;">
                                        <i class="fas fa-image"></i> ä¸Šä¼ äºŒç»´ç å›¾ç‰‡
                                    </label>
                                    <input type="file" id="qrImageUpload" accept="image/*" style="display: none;" onchange="handleQRImageUpload(event)">
                                    <div id="uploadStatus" style="margin-top: 10px; display: none;"></div>
                                </div>
                                
                                <!-- æ–¹å¼2ï¼šå®æ—¶æ‘„åƒå¤´æ‰«æï¼ˆéœ€è¦æ‘„åƒå¤´æƒé™ï¼‰ -->
                                <div class="scan-controls" style="margin-top: 10px;">
                                    <button id="scanButton" onclick="startQRScanner()" class="btn btn-secondary">
                                        <i class="fas fa-camera"></i> å®æ—¶æ‰«æï¼ˆéœ€æ‘„åƒå¤´ï¼‰
                                    </button>
                                    <button id="stopScanButton" onclick="stopQRScanner()" class="btn btn-danger" style="display: none;">
                                        <i class="fas fa-stop"></i> åœæ­¢æ‰«æ
                                    </button>
                                </div>
                                <div id="qrScannerContainer" style="display: none;">
                                    <video id="qrScannerVideo" autoplay playsinline></video>
                                    <div class="scanner-overlay">
                                        <div class="scan-area"></div>
                                    </div>
                                </div>
                                
                                <!-- é¢„è§ˆä¸Šä¼ çš„å›¾ç‰‡ -->
                                <div id="uploadedImagePreview" style="display: none; margin-top: 15px;">
                                    <img id="uploadedImage" style="max-width: 300px; border: 2px solid var(--primary-color); border-radius: 8px;">
                                    <canvas id="uploadCanvas" style="display: none;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingDiv" class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <span>åŠ è½½ä¸­...</span>
            </div>

            <!-- é”™è¯¯æç¤º -->
            <div id="errorDiv" class="error-message" style="display: none;"></div>

            <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
            <div class="info-cards" id="infoCards" style="display: none;">
                <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <h3><i class="fas fa-id-card"></i> åŸºæœ¬ä¿¡æ¯</h3>
                        <!-- ç®¡ç†å‘˜æ“ä½œæŒ‰é’®ï¼ˆä»…åœ¨æŸ¥çœ‹å…¶ä»–ç”¨æˆ·æ—¶æ˜¾ç¤ºï¼‰ -->
                        <div class="admin-actions" id="adminActions" style="display: none;">
                            <button onclick="goToModifyPoints()" class="btn btn-primary btn-sm">
                                <i class="fas fa-coins"></i>
                                åˆ†å‘ç§¯åˆ†
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="info-item">
                            <label>å­¦å·ï¼š</label>
                            <span id="userStuId">-</span>
                        </div>
                        <div class="info-item">
                            <label>èº«ä»½ï¼š</label>
                            <span id="userRole" class="role-badge">-</span>
                        </div>
                        <div class="info-item">
                            <label>å½“å‰ç§¯åˆ†ï¼š</label>
                            <span id="userPoints" class="points-value">-</span>
                        </div>
                        
                        <!-- èº«ä»½äºŒç»´ç åŒºåŸŸ -->
                        <div class="info-item qrcode-item">
                            <label style="align-self: flex-start; margin-top: 10px;">èº«ä»½äºŒç»´ç ï¼š</label>
                            <div id="qrcodeContainer" class="qrcode-container-inline">
                                <button class="generate-qr-btn-inline" onclick="generateQRCode()">
                                    <i class="fas fa-qrcode"></i>
                                    ç”Ÿæˆæˆ‘çš„äºŒç»´ç 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å…³å¡è¿›åº¦å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <h3><i class="fas fa-layer-group"></i> é€šå…³è®°å½•</h3>
                    </div>
                    <div class="card-content">
                        <div id="levelsContainer">
                            <div class="no-data">æš‚æ— é€šå…³è®°å½•</div>
                        </div>
                    </div>
                </div>

                <!-- å¥–å“è®°å½•å¡ç‰‡ -->
                <div class="info-card">
                    <div class="card-header">
                        <h3><i class="fas fa-gift"></i> è·å¾—å¥–å“</h3>
                    </div>
                    <div class="card-content">
                        <div id="prizesContainer">
                            <div class="no-data">æš‚æ— è·å¾—å¥–å“</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ç®¡ç†å‘˜æœç´¢åŠŸèƒ½ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
        </main>
    </div>

    <!-- JavaScript -->
    <script src="/Pages/Common/js/utils.js"></script>
    <script>
        let currentUser = null;
        let targetStuId = null; // è¦æŸ¥è¯¢çš„å­¦å·

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            targetStuId = urlParams.get('stuId');
            
            console.log('ğŸ“„ é¡µé¢åˆå§‹åŒ–:');
            console.log('- å½“å‰URL:', window.location.href);
            console.log('- URLå‚æ•°:', window.location.search);
            console.log('- è§£æçš„targetStuId:', targetStuId);
            
            loadUserInfo();
        });

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                // æ„å»ºè¯·æ±‚URL
                let apiUrl = '/api/user/info';
                if (targetStuId) {
                    apiUrl += `?stuId=${encodeURIComponent(targetStuId)}`;
                }

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.status === 401) {
                    // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œå¹¶å¸¦ä¸Šå›è°ƒURL
                    const currentUrl = encodeURIComponent(window.location.href);
                    window.location.href = `/login?redirect=${currentUrl}`;
                    return;
                }

                if (response.status === 403) {
                    // æƒé™ä¸è¶³
                    showError('æƒé™ä¸è¶³ï¼Œæ‚¨åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯');
                    return;
                }

                if (!response.ok) {
                    if (response.status === 404) {
                        showError('ç”¨æˆ·ä¸å­˜åœ¨');
                    } else {
                        throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                    }
                    return;
                }

                const data = await response.json();
                
                // APIç›´æ¥è¿”å›ç”¨æˆ·å¯¹è±¡
                displayUserInfo(data);
                
                // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ç”¨äºå¯¼èˆªè®¾ç½®
                if (!targetStuId) {
                    // å¦‚æœæŸ¥è¯¢çš„æ˜¯è‡ªå·±ï¼Œåˆ™è®¾ç½®ä¸ºå½“å‰ç”¨æˆ·
                    currentUser = data;
                    // ç­‰å¾…å¯¼èˆªæ åŠ è½½å®Œæˆåå†è®¾ç½®æƒé™
                    waitForNavigation(() => setupNavigation(currentUser.role));
                    // æ˜¾ç¤ºç®¡ç†å‘˜æœç´¢åŠŸèƒ½
                    showAdminSearchIfNeeded(currentUser);
                } else {
                    // å¦‚æœæŸ¥è¯¢çš„æ˜¯å…¶ä»–ç”¨æˆ·ï¼Œéœ€è¦å•ç‹¬è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                    await getCurrentUserForNavigation();
                    // é‡æ–°è°ƒç”¨displayUserInfoä»¥ç¡®ä¿æŒ‰é’®æ˜¾ç¤ºé€»è¾‘æ­£ç¡®
                    displayUserInfo(data);
                }

                // æ›´æ–°é¡µé¢æ ‡é¢˜
                updatePageTitle(data, targetStuId);
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error);
                showError('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            } finally {
                document.getElementById('loadingDiv').style.display = 'none';
            }
        }

        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ç”¨äºå¯¼èˆªè®¾ç½®
        async function getCurrentUserForNavigation() {
            try {
                console.log('ğŸ”„ è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯...');
                
                const response = await fetch('/api/user/info', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    currentUser = await response.json();
                    console.log('âœ… æˆåŠŸè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯:', currentUser);
                    waitForNavigation(() => setupNavigation(currentUser.role));
                    // æ˜¾ç¤ºç®¡ç†å‘˜æœç´¢åŠŸèƒ½
                    showAdminSearchIfNeeded(currentUser);
                } else {
                    console.error('âŒ è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
                }
            } catch (error) {
                console.error('âŒ è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸:', error);
            }
        }

        // æ›´æ–°é¡µé¢æ ‡é¢˜
        function updatePageTitle(userData, queryStuId) {
            const pageHeader = document.querySelector('.page-header h2');
            
            if (queryStuId && currentUser && queryStuId !== currentUser.stuId) {
                // æŸ¥è¯¢ä»–äººä¿¡æ¯
                pageHeader.innerHTML = '<i class="fas fa-user-friends"></i> ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢';
                
                // æ·»åŠ è¿”å›æŒ‰é’®
                const backButton = document.createElement('button');
                backButton.innerHTML = '<i class="fas fa-arrow-left"></i> è¿”å›æˆ‘çš„ä¿¡æ¯';
                backButton.className = 'btn btn-secondary';
                backButton.style.marginLeft = '10px';
                backButton.onclick = function() {
                    window.location.href = '/info';
                };
                pageHeader.appendChild(backButton);
            } else {
                // æŸ¥è¯¢è‡ªå·±ä¿¡æ¯
                pageHeader.innerHTML = '<i class="fas fa-user"></i> ä¸ªäººä¿¡æ¯';
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function displayUserInfo(user) {
            console.log('ğŸ” æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯è°ƒè¯•:');
            console.log('- ç”¨æˆ·æ•°æ®:', user);
            console.log('- ç›®æ ‡å­¦å· (targetStuId):', targetStuId);
            console.log('- å½“å‰ç”¨æˆ·:', currentUser);
            
            // ç¡®ä¿targetStuIdè¢«æ­£ç¡®è®¾ç½®
            if (!targetStuId && user.stuId) {
                // å¦‚æœtargetStuIdä¸ºç©ºä½†ç”¨æˆ·æ•°æ®ä¸­æœ‰stuIdï¼Œè¯´æ˜å¯èƒ½æ˜¯æŸ¥çœ‹ä»–äººä¿¡æ¯
                const urlParams = new URLSearchParams(window.location.search);
                const urlStuId = urlParams.get('stuId');
                if (urlStuId && urlStuId === user.stuId) {
                    targetStuId = urlStuId;
                    console.log('âœ… ä»URLå‚æ•°æ›´æ–°targetStuId:', targetStuId);
                }
            }
            
            // æ›´æ–°åŸºæœ¬ä¿¡æ¯
            const userStuIdElement = document.getElementById('userStuId');
            const userRoleElement = document.getElementById('userRole');
            const userPointsElement = document.getElementById('userPoints');
            
            if (userStuIdElement) userStuIdElement.textContent = user.stuId || '-';
            if (userRoleElement) {
                userRoleElement.textContent = getRoleText(user.role);
                userRoleElement.className = `role-badge role-${user.role}`;
            }
            if (userPointsElement) userPointsElement.textContent = user.points || 0;

            // æ˜¾ç¤ºå…³å¡è¿›åº¦
            const completedLevels = user.completedLevels || [];
            displayLevels(completedLevels, user.stuId);

            // æ˜¾ç¤ºå¥–å“è®°å½• - ä»APIåŠ¨æ€åŠ è½½
            displayPrizes(user.stuId);

            // äºŒç»´ç åŠŸèƒ½æ˜¾ç¤ºé€»è¾‘ï¼š
            // - æŸ¥çœ‹è‡ªå·±ä¿¡æ¯æ—¶ï¼šæ€»æ˜¯æ˜¾ç¤º
            // - æŸ¥çœ‹ä»–äººä¿¡æ¯æ—¶ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥æ˜¾ç¤º
            const qrcodeContainer = document.getElementById('qrcodeContainer');
            const qrcodeCard = qrcodeContainer ? qrcodeContainer.closest('.info-card') : null;
            const generateBtn = qrcodeContainer ? qrcodeContainer.querySelector('.generate-qr-btn') : null;
            
            if (targetStuId && currentUser && targetStuId !== currentUser.stuId) {
                // æŸ¥çœ‹ä»–äººä¿¡æ¯æ—¶
                const isAdmin = currentUser.role === 'admin' || currentUser.role === 'super_admin';
                if (isAdmin) {
                    // ç®¡ç†å‘˜å¯ä»¥ç”Ÿæˆä»–äººèº«ä»½ç 
                    if (qrcodeCard) qrcodeCard.style.display = 'block';
                    if (generateBtn) {
                        generateBtn.innerHTML = '<i class="fas fa-qrcode"></i> ç”Ÿæˆç”¨æˆ·èº«ä»½äºŒç»´ç ';
                    }
                } else {
                    // æ™®é€šç”¨æˆ·ä¸èƒ½ç”Ÿæˆä»–äººèº«ä»½ç 
                    if (qrcodeCard) qrcodeCard.style.display = 'none';
                }
            } else {
                // æŸ¥çœ‹è‡ªå·±ä¿¡æ¯æ—¶
                if (qrcodeCard) qrcodeCard.style.display = 'block';
                if (generateBtn) {
                    generateBtn.innerHTML = '<i class="fas fa-qrcode"></i> ç”Ÿæˆèº«ä»½äºŒç»´ç ';
                }
            }

            // ç®¡ç†å‘˜æ“ä½œæŒ‰é’®çš„æ˜¾ç¤ºé€»è¾‘
            const adminActions = document.getElementById('adminActions');
            
            console.log('ğŸ” ç®¡ç†å‘˜æŒ‰é’®æ˜¾ç¤ºé€»è¾‘æ£€æŸ¥:');
            console.log('- currentUserå­˜åœ¨:', !!currentUser);
            console.log('- currentUser:', currentUser);
            console.log('- æ˜¯å¦ä¸ºç®¡ç†å‘˜:', currentUser ? (currentUser.role === 'admin' || currentUser.role === 'super_admin') : false);
            console.log('- targetStuIdå­˜åœ¨:', !!targetStuId);
            console.log('- targetStuId:', targetStuId);
            console.log('- æ˜¯å¦æŸ¥çœ‹ä»–äºº:', targetStuId && currentUser ? (targetStuId !== currentUser.stuId) : false);
            
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin') && 
                targetStuId && targetStuId !== currentUser.stuId) {
                // ç®¡ç†å‘˜æŸ¥çœ‹ä»–äººä¿¡æ¯æ—¶æ˜¾ç¤ºåˆ†å‘ç§¯åˆ†æŒ‰é’®
                console.log('âœ… æ˜¾ç¤ºåˆ†å‘ç§¯åˆ†æŒ‰é’®');
                if (adminActions) adminActions.style.display = 'flex';
            } else {
                console.log('âŒ éšè—åˆ†å‘ç§¯åˆ†æŒ‰é’®');
                if (adminActions) adminActions.style.display = 'none';
            }

            // ç®¡ç†å‘˜æœç´¢åŠŸèƒ½çš„æ˜¾ç¤ºé€»è¾‘
            const adminSection = document.getElementById('adminSearchSection');
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin')) {
                if (adminSection) adminSection.style.display = 'block';
                
                // å¦‚æœæ­£åœ¨æŸ¥çœ‹ä»–äººä¿¡æ¯ï¼Œé¢„å¡«æœç´¢æ¡†
                if (targetStuId && targetStuId !== currentUser.stuId) {
                    const stuIdInput = document.getElementById('stuIdInput');
                    if (stuIdInput) stuIdInput.value = targetStuId;
                }
            } else {
                if (adminSection) adminSection.style.display = 'none';
            }

            // æ˜¾ç¤ºä¿¡æ¯å¡ç‰‡
            const infoCards = document.getElementById('infoCards');
            if (infoCards) infoCards.style.display = 'block';
        }

        // ç­‰å¾…å¯¼èˆªæ å…ƒç´ åŠ è½½å®Œæˆ
        function waitForNavigation(callback, maxAttempts = 10, currentAttempt = 0) {
            const navItems = ['modifyPointsNavItem', 'memberMgmtNavItem', 'levelMgmtNavItem', 'prizeMgmtNavItem', 'giftRedemptionNavItem'];
            const hasAnyNavItem = navItems.some(id => document.getElementById(id) !== null);
            
            if (hasAnyNavItem || currentAttempt >= maxAttempts) {
                callback();
            } else {
                setTimeout(() => waitForNavigation(callback, maxAttempts, currentAttempt + 1), 100);
            }
        }

        // è®¾ç½®å¯¼èˆªèœå•æƒé™
        function setupNavigation(role) {
            const navItems = {
                'modifyPointsNavItem': ['admin', 'super_admin'],
                'memberMgmtNavItem': ['super_admin'],
                'levelMgmtNavItem': ['super_admin'],
                'prizeMgmtNavItem': ['super_admin'],
                'giftRedemptionNavItem': ['admin', 'super_admin']
            };

            Object.keys(navItems).forEach(itemId => {
                const element = document.getElementById(itemId);
                // æ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼Œé¿å…å¯¼èˆªæ æœªåŠ è½½æ—¶å‡ºé”™
                if (element && navItems[itemId].includes(role)) {
                    element.style.display = 'block';
                }
            });
        }

        // è·å–è§’è‰²æ–‡æœ¬
        function getRoleText(role) {
            const roleMap = {
                'user': 'æ™®é€šæˆå‘˜',
                'admin': 'ç®¡ç†å‘˜',
                'super_admin': 'è¶…çº§ç®¡ç†å‘˜'
            };
            return roleMap[role] || 'æœªçŸ¥è§’è‰²';
        }

        // æ˜¾ç¤ºå…³å¡è¿›åº¦
        async function displayLevels(levelIds, stuId) {
            const container = document.getElementById('levelsContainer');
            
            console.log('ğŸ¯ æ˜¾ç¤ºå…³å¡è¿›åº¦:', { levelIds, stuId });
            
            if (!levelIds || levelIds.length === 0) {
                container.innerHTML = '<div class="no-data">æš‚æ— é€šå…³è®°å½•</div>';
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                container.innerHTML = '<div class="loading-small"><i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</div>';
                
                // è·å–å…³å¡è¯¦ç»†ä¿¡æ¯
                const response = await fetch('/api/levels/details', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ levelIds: levelIds })
                });

                if (response.ok) {
                    const levels = await response.json();
                    console.log('âœ… è·å–åˆ°å…³å¡è¯¦æƒ…:', levels);
                    
                    if (levels && levels.length > 0) {
                        let html = '<div class="levels-list">';
                        levels.forEach((level, index) => {
                            const levelName = level.name || `å…³å¡ ${index + 1}`;
                            const levelDesc = level.description || '';
                            const levelPoints = level.points || 0;
                            
                            html += `
                                <div class="level-item">
                                    <div class="level-info">
                                        <i class="fas fa-trophy level-icon" style="color: #ffd700;"></i>
                                        <div class="level-details">
                                            <span class="level-name">${levelName}</span>
                                            ${levelDesc ? `<span class="level-desc">${levelDesc}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="level-status">
                                        <span class="status-badge completed">
                                            <i class="fas fa-check-circle"></i> å·²å®Œæˆ
                                        </span>
                                        ${levelPoints > 0 ? `<span class="level-points">+${levelPoints}ç§¯åˆ†</span>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div class="no-data">æš‚æ— é€šå…³è®°å½•</div>';
                    }
                } else {
                    // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œæ˜¾ç¤ºç®€åŒ–ç‰ˆæœ¬
                    console.warn('âš ï¸ å…³å¡è¯¦æƒ…APIå¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–æ˜¾ç¤º');
                    let html = '<div class="levels-list">';
                    levelIds.forEach((levelId, index) => {
                        html += `
                            <div class="level-item">
                                <div class="level-info">
                                    <i class="fas fa-trophy level-icon" style="color: #ffd700;"></i>
                                    <span class="level-name">å…³å¡ ${index + 1}</span>
                                </div>
                                <div class="level-status">
                                    <span class="status-badge completed">
                                        <i class="fas fa-check-circle"></i> å·²å®Œæˆ
                                    </span>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('âŒ åŠ è½½å…³å¡ä¿¡æ¯å¤±è´¥:', error);
                container.innerHTML = `<div class="no-data">å…±å®Œæˆ ${levelIds.length} ä¸ªå…³å¡</div>`;
            }
        }

        // æ˜¾ç¤ºå¥–å“è®°å½•
        async function displayPrizes(stuId) {
            const container = document.getElementById('prizesContainer');
            
            console.log('ğŸ æ˜¾ç¤ºå¥–å“è®°å½•:', { stuId });
            
            if (!stuId) {
                container.innerHTML = '<div class="no-data">æš‚æ— è·å¾—å¥–å“</div>';
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                container.innerHTML = '<div class="loading-small"><i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</div>';
                
                // ä»APIè·å–ç”¨æˆ·å¥–å“
                const response = await fetch(`/api/user/prizes/${encodeURIComponent(stuId)}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const prizes = data.prizes || [];
                    
                    console.log('âœ… è·å–åˆ°å¥–å“åˆ—è¡¨:', prizes);
                    
                    if (prizes.length === 0) {
                        container.innerHTML = '<div class="no-data">æš‚æ— è·å¾—å¥–å“</div>';
                        return;
                    }

                    // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
                    const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin');
                    const isViewingOthers = targetStuId && currentUser && targetStuId !== currentUser.stuId;
                    const canRedeem = isAdmin && isViewingOthers;  // åªæœ‰ç®¡ç†å‘˜æŸ¥çœ‹ä»–äººä¿¡æ¯æ—¶æ‰æ˜¾ç¤ºæ ¸é”€æŒ‰é’®

                    let html = '<div class="prizes-list">';
                    prizes.forEach((prize, index) => {
                        const prizeName = prize.prizeName || prize.Name || prize.name || 'æœªçŸ¥å¥–å“';
                        const prizePhoto = prize.prizePhoto || prize.photo || '';
                        const drawTime = prize.drawTime || prize.draw_time || prize.obtainTime;
                        const isRedeemed = prize.redeemed || false;
                        const redeemedAt = prize.redeemedAt || prize.redeem_time;
                        const redeemedBy = prize.redeemedBy || prize.redeemed_by;
                        
                        // æ„å»ºå›¾ç‰‡URL
                        let imageUrl = '';
                        if (prizePhoto) {
                            // å¦‚æœå·²ç»æ˜¯å®Œæ•´URL,ç›´æ¥ä½¿ç”¨
                            if (prizePhoto.startsWith('http://') || prizePhoto.startsWith('https://') || prizePhoto.startsWith('/')) {
                                imageUrl = prizePhoto;
                            } else {
                                // å¦åˆ™æ·»åŠ è·¯å¾„å‰ç¼€
                                imageUrl = `/Assest/Prize/${prizePhoto}`;
                            }
                        }
                        
                        html += `
                            <div class="prize-item" data-prize-index="${index}">
                                <div class="prize-info">
                                    ${imageUrl ? 
                                        `<img src="${imageUrl}" alt="${prizeName}" class="prize-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                                         <i class="fas fa-gift prize-icon" style="display: none; color: #ff6b6b;"></i>` 
                                        : 
                                        `<i class="fas fa-gift prize-icon" style="color: #ff6b6b;"></i>`
                                    }
                                    <div class="prize-details">
                                        <div class="prize-name">${prizeName}</div>
                                        <div class="prize-time">
                                            <i class="fas fa-clock"></i> æŠ½ä¸­æ—¶é—´: ${formatDateTime(drawTime)}
                                        </div>
                                        ${isRedeemed ? 
                                            `<div class="prize-time redeem-info">
                                                <i class="fas fa-check-circle"></i> æ ¸é”€æ—¶é—´: ${formatDateTime(redeemedAt)}
                                            </div>
                                            ${redeemedBy ? `<div class="prize-time redeem-info">
                                                <i class="fas fa-user"></i> æ ¸é”€äºº: ${redeemedBy}
                                            </div>` : ''}` 
                                            : ''
                                        }
                                    </div>
                                </div>
                                <div class="prize-status">
                                    ${isRedeemed 
                                        ? '<span class="status-badge redeemed"><i class="fas fa-check-circle"></i> å·²æ ¸é”€</span>' 
                                        : '<span class="status-badge available"><i class="fas fa-gift"></i> æœªæ ¸é”€</span>'
                                    }
                                    ${canRedeem ? `
                                        <button class="btn btn-sm ${isRedeemed ? 'btn-warning' : 'btn-success'}" 
                                                onclick="toggleRedeemPrize('${stuId}', ${index}, ${isRedeemed})"
                                                style="margin-top: 8px;">
                                            <i class="fas fa-${isRedeemed ? 'undo' : 'check'}"></i>
                                            ${isRedeemed ? 'å–æ¶ˆæ ¸é”€' : 'æ ¸é”€'}
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else if (response.status === 403) {
                    container.innerHTML = '<div class="no-data">æƒé™ä¸è¶³ï¼Œæ— æ³•æŸ¥çœ‹å¥–å“</div>';
                } else if (response.status === 404) {
                    container.innerHTML = '<div class="no-data">ç”¨æˆ·ä¸å­˜åœ¨</div>';
                } else {
                    throw new Error('è·å–å¥–å“å¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ åŠ è½½å¥–å“ä¿¡æ¯å¤±è´¥:', error);
                container.innerHTML = '<div class="no-data">åŠ è½½å¥–å“å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ - æ›´å®Œæ•´çš„æ˜¾ç¤º
        function formatDateTime(dateTimeValue) {
            if (!dateTimeValue) return 'æœªçŸ¥';
            
            try {
                let date;
                // å¤„ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
                if (dateTimeValue.$date) {
                    // MongoDBçš„æ—¥æœŸæ ¼å¼
                    date = new Date(dateTimeValue.$date);
                } else if (typeof dateTimeValue === 'string') {
                    date = new Date(dateTimeValue);
                } else if (dateTimeValue instanceof Date) {
                    date = dateTimeValue;
                } else {
                    date = new Date(dateTimeValue);
                }
                
                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(date.getTime())) {
                    return 'æ—¥æœŸæ ¼å¼é”™è¯¯';
                }
                
                // æ ¼å¼åŒ–ä¸º YYYY-MM-DD HH:MM:SS
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (error) {
                console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', error, dateTimeValue);
                return 'æ—¥æœŸæ ¼å¼é”™è¯¯';
            }
        }

        // åˆ‡æ¢å¥–å“æ ¸é”€çŠ¶æ€
        async function toggleRedeemPrize(stuId, prizeIndex, currentRedeemed) {
            const action = currentRedeemed ? 'å–æ¶ˆæ ¸é”€' : 'æ ¸é”€';
            
            if (!confirm(`ç¡®è®¤${action}è¯¥å¥–å“å—?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/user/prizes/${encodeURIComponent(stuId)}/redeem?prize_index=${prizeIndex}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(data.message || `${action}æˆåŠŸ`);
                    // é‡æ–°åŠ è½½å¥–å“åˆ—è¡¨
                    await displayPrizes(stuId);
                } else {
                    const error = await response.json();
                    alert(error.detail || `${action}å¤±è´¥`);
                }
            } catch (error) {
                console.error(`${action}å¤±è´¥:`, error);
                alert(`${action}å¤±è´¥ï¼Œè¯·é‡è¯•`);
            }
        }



        // å¤‡ç”¨äºŒç»´ç ç”Ÿæˆå‡½æ•°ï¼ˆä½¿ç”¨HTMLè¡¨æ ¼åˆ›å»ºç®€å•çš„äºŒç»´ç ï¼‰
        function generateFallbackQRCode(container, text, stuId) {
            container.innerHTML = `
                <div class="qrcode-display">
                    <div class="qrcode-info">
                        <h4>èº«ä»½è¯†åˆ«äºŒç»´ç </h4>
                        <div class="qrcode-fallback-notice">
                            <p><i class="fas fa-info-circle"></i> äºŒç»´ç åº“åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºæ–‡æœ¬ç‰ˆæœ¬</p>
                        </div>
                        <div class="qrcode-text-display">
                            <div class="qrcode-text-box">
                                <pre>${text}</pre>
                            </div>
                        </div>
                        <p class="qrcode-text">å­¦å·: ${stuId}</p>
                        <div class="qrcode-actions">
                            <button class="copy-btn" onclick="copyToClipboard('${text}')">
                                <i class="fas fa-copy"></i> å¤åˆ¶é“¾æ¥
                            </button>
                        </div>
                        <details class="qrcode-link-details">
                            <summary>æŸ¥çœ‹é“¾æ¥</summary>
                            <div class="qrcode-url">${text}</div>
                        </details>
                    </div>
                </div>
            `;
        }

        // ç”ŸæˆäºŒç»´ç 
        async function generateQRCode() {
            // æƒé™æ£€æŸ¥ï¼šæ™®é€šç”¨æˆ·åªèƒ½ç”Ÿæˆè‡ªå·±çš„äºŒç»´ç ï¼Œç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜å¯ä»¥ç”Ÿæˆä»»ä½•äººçš„äºŒç»´ç 
            if (targetStuId && currentUser && targetStuId !== currentUser.stuId) {
                const isAdmin = currentUser.role === 'admin' || currentUser.role === 'super_admin';
                if (!isAdmin) {
                    alert('åªèƒ½ç”Ÿæˆè‡ªå·±çš„äºŒç»´ç ');
                    return;
                } else {
                    console.log(`ğŸ”‘ ${currentUser.role === 'super_admin' ? 'è¶…çº§ç®¡ç†å‘˜' : 'ç®¡ç†å‘˜'} æ­£åœ¨ç”Ÿæˆç”¨æˆ· ${targetStuId} çš„èº«ä»½ç `);
                }
            }

            const container = document.getElementById('qrcodeContainer');
            container.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';

            try {
                // å†³å®šç”Ÿæˆå“ªä¸ªç”¨æˆ·çš„äºŒç»´ç ï¼š
                // - å¦‚æœæŸ¥çœ‹çš„æ˜¯ä»–äººä¿¡æ¯ä¸”å½“å‰ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼Œç”Ÿæˆè¢«æŸ¥çœ‹ç”¨æˆ·çš„äºŒç»´ç 
                // - å¦åˆ™ç”Ÿæˆå½“å‰ç”¨æˆ·è‡ªå·±çš„äºŒç»´ç 
                let stuIdForQR;
                if (targetStuId && currentUser && targetStuId !== currentUser.stuId) {
                    // æŸ¥çœ‹ä»–äººä¿¡æ¯æ—¶ï¼Œç”Ÿæˆè¢«æŸ¥çœ‹ç”¨æˆ·çš„äºŒç»´ç 
                    stuIdForQR = targetStuId;
                    console.log(`ğŸ¯ ç®¡ç†å‘˜ç”Ÿæˆç”¨æˆ· ${targetStuId} çš„èº«ä»½ç `);
                } else {
                    // æŸ¥çœ‹è‡ªå·±ä¿¡æ¯æ—¶ï¼Œç”Ÿæˆè‡ªå·±çš„äºŒç»´ç 
                    stuIdForQR = currentUser ? currentUser.stuId : (targetStuId || '');
                    console.log(`ğŸ¯ ç”Ÿæˆè‡ªå·±çš„èº«ä»½ç : ${stuIdForQR}`);
                }
                
                const response = await fetch(`/api/user/qrcode/${stuIdForQR}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('ç”ŸæˆäºŒç»´ç å¤±è´¥');
                }

                const data = await response.json();
                
                if (data.success) {
                    // æ¸…ç©ºå®¹å™¨å¹¶å‡†å¤‡ç»“æ„
                    container.innerHTML = `
                        <div class="qrcode-display">
                            <div class="qrcode-info">
                                <h4>èº«ä»½è¯†åˆ«äºŒç»´ç </h4>
                                <canvas id="qrcode-canvas" style="width: 250px; height: 250px; margin: 10px auto; display: block; border: 1px solid #dee2e6; border-radius: 8px;"></canvas>
                                <p class="qrcode-text">å­¦å·: ${data.stuId}</p>
                                <div class="qrcode-actions">
                                    <button class="copy-btn" onclick="copyToClipboard('${data.qrcode}')">
                                        <i class="fas fa-copy"></i> å¤åˆ¶é“¾æ¥
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // ç”Ÿæˆé«˜å®¹é”™ç‡äºŒç»´ç  - ä½¿ç”¨å¯é çš„äºŒç»´ç åº“
                    setTimeout(async () => {
                        const canvas = document.getElementById('qrcode-canvas');
                        
                        console.log('ğŸ¯ å¼€å§‹ç”Ÿæˆé«˜å®¹é”™ç‡äºŒç»´ç ');
                        console.log('- å¯é äºŒç»´ç åº“å¯ç”¨æ€§æ£€æµ‹:');
                        console.log('  QRious:', typeof QRious !== 'undefined' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨');
                        console.log('  qrcode:', typeof qrcode !== 'undefined' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨');
                        console.log('  ReliableQRCode:', typeof ReliableQRCode !== 'undefined' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨');
                        
                        try {
                            console.log('ğŸ” æ£€æŸ¥æ–°çš„QRç ç”Ÿæˆå™¨å¯ç”¨æ€§...');
                            console.log('  - window.QRCodeå­˜åœ¨:', typeof window.QRCode !== 'undefined');
                            console.log('  - window.simpleQRGeneratorå­˜åœ¨:', typeof window.simpleQRGenerator !== 'undefined');
                            console.log('  - window.ReliableQRCodeå­˜åœ¨:', typeof window.ReliableQRCode !== 'undefined');
                            
                            if (typeof window.simpleQRGenerator === 'undefined') {
                                throw new Error('SimpleQRCodeGeneratoræœªåŠ è½½');
                            }
                            
                            console.log('ğŸš€ ä½¿ç”¨SimpleQRCodeGeneratorç”ŸæˆQRç ');
                            
                            // ä½¿ç”¨æ–°çš„ç®€å•QRç ç”Ÿæˆå™¨
                            const dataUrl = await window.simpleQRGenerator.generate(data.qrcode, {
                                size: 250,
                                level: 'H', // é«˜å®¹é”™ç‡
                                background: '#ffffff',
                                foreground: '#000000'
                            });
                            
                            if (dataUrl) {
                                // å°†ç”Ÿæˆçš„äºŒç»´ç ç»˜åˆ¶åˆ°canvas
                                const img = new Image();
                                img.onload = () => {
                                    const ctx = canvas.getContext('2d');
                                    canvas.width = 250;
                                    canvas.height = 250;
                                    ctx.drawImage(img, 0, 0, 250, 250);
                                    console.log('âœ… QRç ç”Ÿæˆå¹¶æ˜¾ç¤ºæˆåŠŸ');
                                };
                                img.onerror = () => {
                                    console.error('âŒ QRç å›¾ç‰‡åŠ è½½å¤±è´¥');
                                    showQRCodeError();
                                };
                                img.src = dataUrl;
                            } else {
                                throw new Error('QRç ç”Ÿæˆè¿”å›ç©ºæ•°æ®');
                            }
                        } catch (error) {
                            console.error('âŒ äºŒç»´ç ç”Ÿæˆå¼‚å¸¸:', error);
                            showQRCodeError();
                        }
                        
                        // é”™è¯¯å¤„ç†
                        function showQRCodeError() {
                            const ctx = canvas.getContext('2d');
                            canvas.width = 250;
                            canvas.height = 250;
                            
                            // ç»˜åˆ¶é”™è¯¯æç¤º
                            ctx.fillStyle = '#f8f9fa';
                            ctx.fillRect(0, 0, 250, 250);
                            ctx.strokeStyle = '#dee2e6';
                            ctx.strokeRect(0, 0, 250, 250);
                            
                            ctx.fillStyle = '#6c757d';
                            ctx.font = '16px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText('äºŒç»´ç ç”Ÿæˆå¤±è´¥', 125, 110);
                            ctx.fillText('è¯·åˆ·æ–°é¡µé¢é‡è¯•', 125, 135);
                            
                            // æ˜¾ç¤ºé“¾æ¥æ–‡æœ¬å¤‡ç”¨æ–¹æ¡ˆ
                            ctx.font = '12px Arial';
                            ctx.fillStyle = '#007bff';
                            ctx.fillText('é“¾æ¥: ' + data.qrcode.substring(0, 25) + '...', 125, 160);
                        }
                    }, 300); // å»¶é•¿ç­‰å¾…æ—¶é—´ç¡®ä¿CDNå®Œå…¨åŠ è½½
                } else {
                    throw new Error('ç”ŸæˆäºŒç»´ç å¤±è´¥');
                }
            } catch (error) {
                console.error('ç”ŸæˆäºŒç»´ç é”™è¯¯:', error);
                container.innerHTML = `
                    <div class="error">ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•</div>
                    <button class="generate-qr-btn" onclick="generateQRCode()">
                        <i class="fas fa-qrcode"></i>
                        é‡æ–°ç”Ÿæˆ
                    </button>
                `;
            }
        }

        // æ˜¾ç¤ºæ ¸é”€ç 
        function showRedemptionCode(code) {
            alert(`æ ¸é”€ç : ${code}\n\nè¯·å°†æ­¤ç ç»™ç®¡ç†å‘˜è¿›è¡Œå¥–å“æ ¸é”€`);
        }

        // æœç´¢ç”¨æˆ·ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
        async function searchUser() {
            const stuId = document.getElementById('searchStuId').value.trim();
            if (!stuId) {
                alert('è¯·è¾“å…¥å­¦å·');
                return;
            }

            // ç›´æ¥è·³è½¬åˆ°å¸¦å‚æ•°çš„ä¿¡æ¯é¡µé¢
            window.location.href = `/info?stuId=${encodeURIComponent(stuId)}`;
        }

        // è·³è½¬åˆ°åˆ†å‘ç§¯åˆ†é¡µé¢ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
        function goToModifyPoints() {
            // æƒé™äºŒæ¬¡ç¡®è®¤
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
                alert('æƒé™ä¸è¶³ï¼Œåªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ†å‘ç§¯åˆ†');
                return;
            }

            console.log('ğŸ” è°ƒè¯•ä¿¡æ¯:');
            console.log('- å½“å‰ç”¨æˆ·:', currentUser);
            console.log('- ç›®æ ‡å­¦å· (targetStuId):', targetStuId);
            console.log('- å½“å‰URLå‚æ•°:', window.location.search);
            
            // å¦‚æœtargetStuIdä¸ºç©ºï¼Œå°è¯•ä»URLå‚æ•°é‡æ–°è·å–
            if (!targetStuId) {
                const urlParams = new URLSearchParams(window.location.search);
                targetStuId = urlParams.get('stuId');
                console.log('- ä»URLé‡æ–°è·å–çš„å­¦å·:', targetStuId);
            }

            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰targetStuIdï¼Œå°è¯•ä»é¡µé¢æ˜¾ç¤ºçš„å­¦å·è·å–
            if (!targetStuId) {
                const stuIdElement = document.getElementById('userStuId');
                if (stuIdElement) {
                    targetStuId = stuIdElement.textContent.trim();
                    console.log('- ä»é¡µé¢å…ƒç´ è·å–çš„å­¦å·:', targetStuId);
                }
            }

            if (targetStuId && targetStuId !== currentUser.stuId) {
                // æºå¸¦å­¦å·å‚æ•°è·³è½¬åˆ°åˆ†å‘ç§¯åˆ†é¡µé¢
                const jumpUrl = `/modifypoints?stuId=${encodeURIComponent(targetStuId)}`;
                console.log(`ğŸ¯ ç®¡ç†å‘˜ ${currentUser.stuId} å°†ä¸ºç”¨æˆ· ${targetStuId} åˆ†å‘ç§¯åˆ†`);
                console.log(`ğŸ”— è·³è½¬é“¾æ¥: ${jumpUrl}`);
                window.location.href = jumpUrl;
            } else {
                // å¦‚æœæ²¡æœ‰ç›®æ ‡å­¦å·æˆ–è€…æ˜¯è‡ªå·±ï¼Œç›´æ¥è·³è½¬åˆ°åˆ†å‘ç§¯åˆ†é¡µé¢
                console.log('âš ï¸ æ²¡æœ‰æœ‰æ•ˆçš„ç›®æ ‡å­¦å·ï¼Œè·³è½¬åˆ°ç©ºç™½ç§¯åˆ†é¡µé¢');
                console.log('- targetStuId:', targetStuId);
                console.log('- currentUser.stuId:', currentUser?.stuId);
                window.location.href = '/modifypoints';
            }
        }



        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            if (!timestamp) return 'æœªçŸ¥æ—¶é—´';
            
            try {
                const date = new Date(timestamp);
                return date.toLocaleString('zh-CN');
            } catch (e) {
                return 'æœªçŸ¥æ—¶é—´';
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                // ä½¿ç”¨ç°ä»£çš„ Clipboard API
                navigator.clipboard.writeText(text).then(function() {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }, function() {
                    // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                fallbackCopyTextToClipboard(text);
            }
        }

        // é™çº§å¤åˆ¶æ–¹æ³•
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // é¿å…æ»šåŠ¨åˆ°åº•éƒ¨
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                } else {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
                }
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
            }

            document.body.removeChild(textArea);
        }

        // ç™»å‡º
        async function logout() {
            if (confirm('ç¡®è®¤è¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                try {
                    await fetch('/api/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                } catch (error) {
                    console.error('ç™»å‡ºé”™è¯¯:', error);
                } finally {
                    window.location.href = '/login';
                }
            }
        }

        // è°ƒè¯•å‡½æ•°ï¼šæ‰‹åŠ¨æ£€æŸ¥å’Œæ›´æ–°æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        function debugCheckAdminActions() {
            console.log('ğŸ› ï¸ æ‰‹åŠ¨æ£€æŸ¥ç®¡ç†å‘˜æŒ‰é’®çŠ¶æ€:');
            console.log('å½“å‰çŠ¶æ€å¿«ç…§:');
            console.log('- URL:', window.location.href);
            console.log('- targetStuId:', targetStuId);
            console.log('- currentUser:', currentUser);
            
            const adminActions = document.getElementById('adminActions');
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin') && 
                targetStuId && targetStuId !== currentUser.stuId) {
                console.log('âœ… åº”è¯¥æ˜¾ç¤ºåˆ†å‘ç§¯åˆ†æŒ‰é’®');
                adminActions.style.display = 'flex';
            } else {
                console.log('âŒ åº”è¯¥éšè—åˆ†å‘ç§¯åˆ†æŒ‰é’®');
                adminActions.style.display = 'none';
            }
            
            return {
                hasCurrentUser: !!currentUser,
                isAdmin: currentUser ? (currentUser.role === 'admin' || currentUser.role === 'super_admin') : false,
                hasTargetStuId: !!targetStuId,
                isViewingOthers: targetStuId && currentUser ? (targetStuId !== currentUser.stuId) : false,
                shouldShowButton: currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin') && 
                                 targetStuId && targetStuId !== currentUser.stuId
            };
        }

        // åœ¨æ§åˆ¶å°æš´éœ²è°ƒè¯•å‡½æ•°
        window.debugCheckAdminActions = debugCheckAdminActions;
    </script>
    

    
    <!-- åº“åŠ è½½æ£€æµ‹å’Œåˆå§‹åŒ–è„šæœ¬ -->
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æµ‹æ–°QRç ç”Ÿæˆå™¨çš„å¯ç”¨æ€§
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“‹ æ–°QRç ç”Ÿæˆå™¨å¯ç”¨æ€§æ£€æµ‹:');
            
            // è¯¦ç»†æ£€æµ‹å„ä¸ªåº“çš„çŠ¶æ€
            console.log('ğŸ” è¯¦ç»†åº“æ£€æµ‹:');
            console.log('  - window.QRCode:', typeof window.QRCode);
            console.log('  - window.simpleQRGenerator:', typeof window.simpleQRGenerator);
            console.log('  - window.SimpleQRCodeGenerator:', typeof window.SimpleQRCodeGenerator);
            console.log('  - window.ReliableQRCode:', typeof window.ReliableQRCode);
            
            if (window.simpleQRGenerator) {
                console.log('  - simpleQRGenerator.generate:', typeof window.simpleQRGenerator.generate);
                console.log('  - simpleQRGeneratorç‰ˆæœ¬:', window.simpleQRGenerator.version);
            }
            
            if (typeof window.QRCode !== 'undefined' && typeof window.simpleQRGenerator !== 'undefined') {
                console.log('âœ… æ–°QRç ç”Ÿæˆå™¨åŠ è½½æˆåŠŸ');
                console.log('ğŸ“Š å¯ç”¨ç»„ä»¶:');
                console.log('  - QRCode.js: æ ¸å¿ƒåº“');
                console.log('  - SimpleQRCodeGenerator: åŒ…è£…å™¨');
                if (typeof window.ReliableQRCode !== 'undefined') console.log('  - ReliableQRCode: å…¼å®¹æ¥å£');
                console.log('âœ… å‡†å¤‡ç”Ÿæˆé«˜è´¨é‡ã€é«˜å®¹é”™ç‡QRç ');
            } else {
                console.error('âŒ æ–°QRç ç”Ÿæˆå™¨æœªåŠ è½½å®Œå…¨ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„');
                console.log('ğŸ”„ å»ºè®®æ“ä½œ:');
                console.log('  1. æ£€æŸ¥/Pages/Common/js/libs/ç›®å½•ä¸‹çš„qrcode.min.jsæ–‡ä»¶');
                console.log('  2. æ£€æŸ¥/Pages/Common/js/libs/ç›®å½•ä¸‹çš„simple-qr-generator.jsæ–‡ä»¶');
                console.log('  3. ç¡®è®¤æ–‡ä»¶è·¯å¾„æ­£ç¡®');
            }
        });
        
        // å»¶è¿Ÿæ£€æµ‹ï¼Œç¡®ä¿æ‰€æœ‰CDNåº“éƒ½æœ‰æœºä¼šåŠ è½½
        setTimeout(function() {
            if (typeof QRCode === 'undefined') {
                console.warn('âš ï¸ å»¶è¿Ÿæ£€æµ‹: QRCode.jsåº“ä»æœªåŠ è½½');
                console.log('ğŸ’¡ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:');
                console.log('  - ç½‘ç»œè¾ƒæ…¢ï¼Œè¯·ç­‰å¾…æ›´é•¿æ—¶é—´');
                console.log('  - CDNæœåŠ¡æš‚æ—¶ä¸å¯ç”¨');
                console.log('  - é˜²ç«å¢™é˜»æ­¢äº†CDNè®¿é—®');
            }
        }, 2000);

        // ç®¡ç†å‘˜åŠŸèƒ½ç›¸å…³å‡½æ•°
        
        // æ˜¾ç¤ºç®¡ç†å‘˜æœç´¢åŠŸèƒ½ï¼ˆå¦‚æœç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼‰
        function showAdminSearchIfNeeded(user) {
            const adminSearchSection = document.getElementById('adminSearchSection');
            if (user && (user.role === 'admin' || user.role === 'super_admin')) {
                adminSearchSection.style.display = 'block';
                console.log('âœ… æ˜¾ç¤ºç®¡ç†å‘˜æœç´¢åŠŸèƒ½');
            } else {
                adminSearchSection.style.display = 'none';
            }
        }

        // é€šè¿‡å­¦å·æœç´¢ç”¨æˆ·
        async function searchUserByStuId() {
            const stuIdInput = document.getElementById('stuIdInput');
            const stuId = stuIdInput.value.trim();
            
            if (!stuId) {
                alert('è¯·è¾“å…¥å­¦å·');
                return;
            }
            
            // æ£€æŸ¥æƒé™
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
                alert('æƒé™ä¸è¶³');
                return;
            }
            
            // è·³è½¬åˆ°ç”¨æˆ·ä¿¡æ¯é¡µé¢
            window.location.href = `/info?stuId=${encodeURIComponent(stuId)}`;
        }

        // äºŒç»´ç æ‰«æç›¸å…³å˜é‡
        let qrScanner = null;
        let scannerStream = null;

        // å¼€å§‹äºŒç»´ç æ‰«æ
        async function startQRScanner() {
            try {
                // æ£€æŸ¥æƒé™
                if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
                    alert('æƒé™ä¸è¶³');
                    return;
                }

                // è¯¦ç»†çš„æµè§ˆå™¨æ”¯æŒæ£€æµ‹
                console.log('å¼€å§‹æ£€æµ‹æµè§ˆå™¨æ‘„åƒå¤´æ”¯æŒ...');
                console.log('navigator.mediaDevices:', navigator.mediaDevices);
                console.log('å½“å‰åè®®:', window.location.protocol);
                console.log('å½“å‰ä¸»æœº:', window.location.hostname);
                
                // æ£€æŸ¥ HTTPS è¦æ±‚ï¼ˆlocalhost é™¤å¤–ï¼‰
                const isSecureContext = window.isSecureContext || 
                                       window.location.protocol === 'https:' || 
                                       window.location.hostname === 'localhost' || 
                                       window.location.hostname === '127.0.0.1' ||
                                       window.location.hostname.startsWith('192.168.') ||
                                       window.location.hostname.startsWith('10.') ||
                                       window.location.hostname.endsWith('.local');
                
                console.log('æ˜¯å¦ä¸ºå®‰å…¨ä¸Šä¸‹æ–‡:', isSecureContext);
                
                if (!isSecureContext) {
                    alert('âš ï¸ å®‰å…¨æç¤º\n\næ‚¨çš„ç½‘ç«™æ­£åœ¨ä½¿ç”¨éå®‰å…¨çš„ HTTP åè®®ã€‚\nç°ä»£æµè§ˆå™¨è¦æ±‚ä½¿ç”¨ HTTPS æ‰èƒ½è®¿é—®æ‘„åƒå¤´ã€‚\n\nè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€ï¼š\n1. é€šè¿‡ localhost æˆ– 127.0.0.1 è®¿é—®\n2. é…ç½®ç½‘ç«™ä½¿ç”¨ HTTPS\n3. ä½¿ç”¨å±€åŸŸç½‘ IP (å¦‚ 192.168.x.x)');
                    return;
                }

                // æ£€æŸ¥æµè§ˆå™¨ API æ”¯æŒ
                if (!navigator.mediaDevices) {
                    alert('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒ\n\næ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ mediaDevices APIã€‚\n\nå»ºè®®ä½¿ç”¨ä»¥ä¸‹æµè§ˆå™¨ï¼š\nâ€¢ Chrome 53+\nâ€¢ Firefox 36+\nâ€¢ Safari 11+\nâ€¢ Edge 79+');
                    return;
                }
                
                if (!navigator.mediaDevices.getUserMedia) {
                    alert('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒ\n\næ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ getUserMedia APIã€‚\nè¯·æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬çš„æµè§ˆå™¨ã€‚');
                    return;
                }

                const video = document.getElementById('qrScannerVideo');
                const container = document.getElementById('qrScannerContainer');
                const scanButton = document.getElementById('scanButton');
                const stopButton = document.getElementById('stopScanButton');

                // è®¾ç½®æŒ‰é’®çŠ¶æ€
                scanButton.disabled = true;
                scanButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¯åŠ¨ä¸­...';

                // è·å–å¯ç”¨çš„æ‘„åƒå¤´åˆ—è¡¨
                let devices;
                try {
                    devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    console.log('ğŸ“¹ æ£€æµ‹åˆ°çš„æ‘„åƒå¤´æ•°é‡:', videoDevices.length);
                    videoDevices.forEach((device, index) => {
                        console.log(`æ‘„åƒå¤´ ${index + 1}:`, device.label || `æ‘„åƒå¤´ ${index + 1}`, device.deviceId);
                    });
                } catch (e) {
                    console.warn('æ— æ³•æšä¸¾è®¾å¤‡:', e);
                }

                try {
                    // é¦–å…ˆå°è¯•ä½¿ç”¨åç½®æ‘„åƒå¤´ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
                    console.log('ğŸ”„ å°è¯•è®¿é—®åç½®æ‘„åƒå¤´...');
                    scannerStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280, max: 1920 },
                            height: { ideal: 720, max: 1080 }
                        } 
                    });
                    console.log('âœ… æˆåŠŸè®¿é—®åç½®æ‘„åƒå¤´');
                } catch (error) {
                    console.warn('âš ï¸ åç½®æ‘„åƒå¤´è®¿é—®å¤±è´¥ï¼Œå°è¯•å‰ç½®æ‘„åƒå¤´:', error.name);
                    try {
                        // å¦‚æœåç½®æ‘„åƒå¤´å¤±è´¥ï¼Œå°è¯•å‰ç½®æ‘„åƒå¤´
                        console.log('ğŸ”„ å°è¯•è®¿é—®å‰ç½®æ‘„åƒå¤´...');
                        scannerStream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: { ideal: 'user' },
                                width: { ideal: 1280, max: 1920 },
                                height: { ideal: 720, max: 1080 }
                            } 
                        });
                        console.log('âœ… æˆåŠŸè®¿é—®å‰ç½®æ‘„åƒå¤´');
                    } catch (error2) {
                        console.warn('âš ï¸ å‰ç½®æ‘„åƒå¤´è®¿é—®å¤±è´¥ï¼Œå°è¯•é»˜è®¤æ‘„åƒå¤´:', error2.name);
                        // æœ€åå°è¯•ä¸æŒ‡å®šæ‘„åƒå¤´ç±»å‹ï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
                        console.log('ğŸ”„ å°è¯•è®¿é—®é»˜è®¤æ‘„åƒå¤´...');
                        scannerStream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                width: { ideal: 1280, max: 1920 },
                                height: { ideal: 720, max: 1080 }
                            } 
                        });
                        console.log('âœ… æˆåŠŸè®¿é—®é»˜è®¤æ‘„åƒå¤´');
                    }
                }
                
                // è®¾ç½®è§†é¢‘æº
                video.srcObject = scannerStream;
                console.log('ğŸ“¹ è§†é¢‘æµå·²è®¾ç½®åˆ° video å…ƒç´ ');
                
                // ç­‰å¾…è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ
                video.onloadedmetadata = async function() {
                    console.log('ğŸ“Š è§†é¢‘å…ƒæ•°æ®å·²åŠ è½½');
                    try {
                        await video.play();
                        console.log('â–¶ï¸ è§†é¢‘æ’­æ”¾æˆåŠŸ');
                        console.log('ğŸ“ è§†é¢‘å®é™…å°ºå¯¸:', video.videoWidth, 'x', video.videoHeight);
                        
                        // æ˜¾ç¤ºæ‰«æå™¨ç•Œé¢
                        container.style.display = 'block';
                        scanButton.style.display = 'none';
                        stopButton.style.display = 'inline-block';
                        scanButton.disabled = false;
                        scanButton.innerHTML = '<i class="fas fa-camera"></i> å¼€å§‹æ‰«æ';
                        
                        // åˆå§‹åŒ–äºŒç»´ç æ£€æµ‹
                        initQRDetection(video);
                    } catch (playError) {
                        console.error('âŒ è§†é¢‘æ’­æ”¾å¤±è´¥:', playError);
                        alert('è§†é¢‘æ’­æ”¾å¤±è´¥: ' + playError.message);
                        stopQRScanner();
                    }
                };
                
                // å¤„ç†è§†é¢‘åŠ è½½é”™è¯¯
                video.onerror = function(e) {
                    console.error('âŒ è§†é¢‘åŠ è½½é”™è¯¯:', e);
                    alert('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                    stopQRScanner();
                };

            } catch (error) {
                console.error('å¯åŠ¨æ‘„åƒå¤´å¤±è´¥:', error);
                console.error('é”™è¯¯åç§°:', error.name);
                console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                const scanButton = document.getElementById('scanButton');
                scanButton.disabled = false;
                scanButton.innerHTML = '<i class="fas fa-camera"></i> å¼€å§‹æ‰«æ';
                
                // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMessage = 'ğŸ“· æ— æ³•è®¿é—®æ‘„åƒå¤´\n\n';
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += 'âŒ æƒé™è¢«æ‹’ç»\n\n';
                    errorMessage += 'è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š\n';
                    errorMessage += '1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„ ğŸ”’ æˆ– â“˜ å›¾æ ‡\n';
                    errorMessage += '2. æ‰¾åˆ°"æ‘„åƒå¤´"æƒé™è®¾ç½®\n';
                    errorMessage += '3. é€‰æ‹©"å…è®¸"\n';
                    errorMessage += '4. åˆ·æ–°é¡µé¢åé‡è¯•\n\n';
                    errorMessage += 'ğŸ’¡ æç¤ºï¼šæœ‰äº›æµè§ˆå™¨éœ€è¦æ‚¨æ‰‹åŠ¨å…è®¸æ¯ä¸ªç½‘ç«™è®¿é—®æ‘„åƒå¤´';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += 'âŒ æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡\n\n';
                    errorMessage += 'è¯·æ£€æŸ¥ï¼š\n';
                    errorMessage += 'â€¢ æ˜¯å¦è¿æ¥äº†æ‘„åƒå¤´ï¼ˆç¬”è®°æœ¬é€šå¸¸å†…ç½®ï¼‰\n';
                    errorMessage += 'â€¢ è®¾å¤‡ç®¡ç†å™¨ä¸­æ‘„åƒå¤´æ˜¯å¦æ­£å¸¸\n';
                    errorMessage += 'â€¢ å…¶ä»–åº”ç”¨æ˜¯å¦èƒ½ä½¿ç”¨æ‘„åƒå¤´';
                } else if (error.name === 'NotSupportedError' || error.name === 'TypeError') {
                    errorMessage += 'âŒ æµè§ˆå™¨ä¸æ”¯æŒ\n\n';
                    errorMessage += 'æ‚¨çš„æµè§ˆå™¨ç‰ˆæœ¬è¿‡æ—§æˆ–ä¸æ”¯æŒæ‘„åƒå¤´ APIã€‚\n\n';
                    errorMessage += 'å»ºè®®ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ï¼š\n';
                    errorMessage += 'â€¢ Google Chrome\n';
                    errorMessage += 'â€¢ Microsoft Edge\n';
                    errorMessage += 'â€¢ Mozilla Firefox\n';
                    errorMessage += 'â€¢ Safari (iOS/macOS)';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += 'âŒ æ‘„åƒå¤´å·²è¢«å ç”¨\n\n';
                    errorMessage += 'æ‘„åƒå¤´æ­£åœ¨è¢«å…¶ä»–ç¨‹åºä½¿ç”¨ã€‚\n\n';
                    errorMessage += 'è¯·å…³é—­ä»¥ä¸‹å¯èƒ½å ç”¨æ‘„åƒå¤´çš„ç¨‹åºï¼š\n';
                    errorMessage += 'â€¢ è§†é¢‘ä¼šè®®è½¯ä»¶ï¼ˆZoomã€Teams ç­‰ï¼‰\n';
                    errorMessage += 'â€¢ å…¶ä»–æµè§ˆå™¨æ ‡ç­¾é¡µ\n';
                    errorMessage += 'â€¢ æ‘„åƒå¤´ç›¸å…³åº”ç”¨\n';
                    errorMessage += '\nç„¶ååˆ·æ–°é¡µé¢é‡è¯•';
                } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                    errorMessage += 'âŒ æ‘„åƒå¤´ä¸æ»¡è¶³è¦æ±‚\n\n';
                    errorMessage += 'æ‚¨çš„æ‘„åƒå¤´ä¸æ”¯æŒæ‰€éœ€çš„åˆ†è¾¨ç‡æˆ–é…ç½®ã€‚\n';
                    errorMessage += 'å°è¯•ä½¿ç”¨å…¶ä»–æ‘„åƒå¤´æˆ–æ›´æ–°é©±åŠ¨ç¨‹åºã€‚';
                } else if (error.name === 'SecurityError') {
                    errorMessage += 'âŒ å®‰å…¨é™åˆ¶\n\n';
                    errorMessage += 'å½“å‰ç¯å¢ƒä¸å…è®¸è®¿é—®æ‘„åƒå¤´ã€‚\n\n';
                    errorMessage += 'å¯èƒ½çš„åŸå› ï¼š\n';
                    errorMessage += 'â€¢ ä½¿ç”¨äº†ä¸å®‰å…¨çš„ HTTP åè®®ï¼ˆéœ€è¦ HTTPSï¼‰\n';
                    errorMessage += 'â€¢ æµè§ˆå™¨å®‰å…¨è®¾ç½®é˜»æ­¢äº†è®¿é—®\n';
                    errorMessage += 'â€¢ iframe ä¸­çš„å®‰å…¨é™åˆ¶';
                } else {
                    errorMessage += `âŒ æœªçŸ¥é”™è¯¯\n\n`;
                    errorMessage += `é”™è¯¯ç±»å‹: ${error.name || 'æœªçŸ¥'}\n`;
                    errorMessage += `é”™è¯¯ä¿¡æ¯: ${error.message || 'æ— è¯¦ç»†ä¿¡æ¯'}\n\n`;
                    errorMessage += 'è¯·å°è¯•ï¼š\n';
                    errorMessage += 'â€¢ åˆ·æ–°é¡µé¢\n';
                    errorMessage += 'â€¢ é‡å¯æµè§ˆå™¨\n';
                    errorMessage += 'â€¢ ä½¿ç”¨å…¶ä»–æµè§ˆå™¨';
                }
                alert(errorMessage);
            }
        }

        // ========== æ–°å¢ï¼šä¸Šä¼ äºŒç»´ç å›¾ç‰‡æ‰«æï¼ˆæ— éœ€æ‘„åƒå¤´ï¼‰==========
        
        /**
         * å¤„ç†ä¸Šä¼ çš„äºŒç»´ç å›¾ç‰‡
         * è¿™ä¸ªæ–¹æ³•ä¸éœ€è¦æ‘„åƒå¤´ï¼Œå®Œå…¨åœ¨å‰ç«¯å¤„ç†
         */
        async function handleQRImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('uploadStatus');
            const previewDiv = document.getElementById('uploadedImagePreview');
            const uploadedImage = document.getElementById('uploadedImage');
            
            // æ˜¾ç¤ºçŠ¶æ€
            statusDiv.style.display = 'block';
            statusDiv.className = 'status info';
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¯†åˆ«äºŒç»´ç ...';
            
            console.log('ğŸ“· å¼€å§‹å¤„ç†ä¸Šä¼ çš„å›¾ç‰‡:', file.name);
            
            try {
                // æ£€æŸ¥ jsQR åº“æ˜¯å¦åŠ è½½
                if (typeof jsQR === 'undefined') {
                    throw new Error('äºŒç»´ç è¯†åˆ«åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
                
                // è¯»å–å›¾ç‰‡
                const imageData = await readImageFile(file);
                
                // æ˜¾ç¤ºé¢„è§ˆ
                uploadedImage.src = imageData;
                previewDiv.style.display = 'block';
                
                // åˆ›å»ºå›¾ç‰‡å¯¹è±¡
                const img = new Image();
                img.onload = async function() {
                    console.log('âœ… å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå°ºå¯¸:', img.width, 'x', img.height);
                    
                    // æ›´æ–°çŠ¶æ€
                    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¯†åˆ«ï¼ˆä½¿ç”¨å¢å¼ºç®—æ³•ï¼‰...';
                    
                    try {
                        // ä½¿ç”¨å¢å¼ºè¯†åˆ«ç®—æ³•ï¼ˆæ”¯æŒå¤šæ¬¡å°è¯•å’Œå›¾åƒé¢„å¤„ç†ï¼‰
                        const result = await tryRecognizeQRCode(img);
                        
                        if (result && result.data) {
                            console.log('ğŸ‰ è¯†åˆ«æˆåŠŸï¼äºŒç»´ç å†…å®¹:', result.data);
                            console.log('è¯†åˆ«æ–¹æ³•:', result.method);
                            statusDiv.className = 'status success';
                            statusDiv.innerHTML = `
                                <i class="fas fa-check-circle"></i> è¯†åˆ«æˆåŠŸï¼æ­£åœ¨è·³è½¬...<br>
                                <small style="opacity: 0.7;">è¯†åˆ«æ–¹æ³•: ${result.method}</small>
                            `;
                            
                            // å¤„ç†äºŒç»´ç å†…å®¹
                            processQRCodeResult(result.data);
                        } else {
                            console.warn('âŒ æ‰€æœ‰è¯†åˆ«æ–¹æ³•éƒ½å¤±è´¥äº†');
                            statusDiv.className = 'status error';
                            statusDiv.innerHTML = `
                                <i class="fas fa-exclamation-triangle"></i> æœªèƒ½è¯†åˆ«äºŒç»´ç <br>
                                <small>
                                    â€¢ è¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°<br>
                                    â€¢ äºŒç»´ç å®Œæ•´å¯è§<br>
                                    â€¢ å…‰çº¿å……è¶³ï¼Œé¿å…åå…‰<br>
                                    â€¢ äºŒç»´ç å å›¾ç‰‡è‡³å°‘ 30%<br>
                                    â€¢ å°è¯•é‡æ–°æ‹ç…§æˆ–ä½¿ç”¨å­¦å·æŸ¥è¯¢
                                </small>
                            `;
                        }
                    } catch (error) {
                        console.error('âŒ è¯†åˆ«è¿‡ç¨‹å‡ºé”™:', error);
                        statusDiv.className = 'status error';
                        statusDiv.innerHTML = `
                            <i class="fas fa-exclamation-circle"></i> è¯†åˆ«å¤±è´¥: ${error.message}<br>
                            <small>è¯·å°è¯•å…¶ä»–å›¾ç‰‡æˆ–ä½¿ç”¨å­¦å·æŸ¥è¯¢</small>
                        `;
                    }
                };
                
                img.onerror = function() {
                    throw new Error('å›¾ç‰‡åŠ è½½å¤±è´¥');
                };
                
                img.src = imageData;
                
            } catch (error) {
                console.error('âŒ å¤„ç†å›¾ç‰‡å¤±è´¥:', error);
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i> å¤„ç†å¤±è´¥: ${error.message}<br>
                    <small>è¯·å°è¯•å…¶ä»–å›¾ç‰‡æˆ–ä½¿ç”¨å­¦å·æŸ¥è¯¢</small>
                `;
                previewDiv.style.display = 'none';
            }
        }
        
        /**
         * å¢å¼ºçš„äºŒç»´ç è¯†åˆ«ç®—æ³•
         * ä½¿ç”¨å¤šç§å›¾åƒå¤„ç†æ–¹æ³•å’Œå‚æ•°ç»„åˆï¼Œæé«˜è¯†åˆ«æˆåŠŸç‡
         */
        async function tryRecognizeQRCode(img) {
            const canvas = document.getElementById('uploadCanvas');
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½® canvas å°ºå¯¸
            canvas.width = img.width;
            canvas.height = img.height;
            
            // å®šä¹‰å¤šç§è¯†åˆ«ç­–ç•¥
            const strategies = [
                // ç­–ç•¥ 1: åŸå›¾ç›´æ¥è¯†åˆ«
                {
                    name: 'åŸå›¾',
                    process: (ctx, width, height) => {
                        ctx.drawImage(img, 0, 0);
                        return ctx.getImageData(0, 0, width, height);
                    },
                    options: { inversionAttempts: "dontInvert" }
                },
                
                // ç­–ç•¥ 2: åŸå›¾ + å°è¯•åè‰²
                {
                    name: 'åŸå›¾ï¼ˆå°è¯•åè‰²ï¼‰',
                    process: (ctx, width, height) => {
                        ctx.drawImage(img, 0, 0);
                        return ctx.getImageData(0, 0, width, height);
                    },
                    options: { inversionAttempts: "attemptBoth" }
                },
                
                // ç­–ç•¥ 3: å¢å¼ºå¯¹æ¯”åº¦
                {
                    name: 'å¯¹æ¯”åº¦å¢å¼º',
                    process: (ctx, width, height) => {
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, width, height);
                        enhanceContrast(imageData, 1.5);
                        ctx.putImageData(imageData, 0, 0);
                        return ctx.getImageData(0, 0, width, height);
                    },
                    options: { inversionAttempts: "attemptBoth" }
                },
                
                // ç­–ç•¥ 4: ç°åº¦åŒ– + å¯¹æ¯”åº¦å¢å¼º
                {
                    name: 'ç°åº¦åŒ–+å¯¹æ¯”åº¦',
                    process: (ctx, width, height) => {
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, width, height);
                        grayscale(imageData);
                        enhanceContrast(imageData, 2.0);
                        ctx.putImageData(imageData, 0, 0);
                        return ctx.getImageData(0, 0, width, height);
                    },
                    options: { inversionAttempts: "attemptBoth" }
                },
                
                // ç­–ç•¥ 5: äºŒå€¼åŒ–å¤„ç†
                {
                    name: 'äºŒå€¼åŒ–',
                    process: (ctx, width, height) => {
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, width, height);
                        grayscale(imageData);
                        binarize(imageData, 128);
                        ctx.putImageData(imageData, 0, 0);
                        return ctx.getImageData(0, 0, width, height);
                    },
                    options: { inversionAttempts: "attemptBoth" }
                },
                
                // ç­–ç•¥ 6: è‡ªé€‚åº”äºŒå€¼åŒ–
                {
                    name: 'è‡ªé€‚åº”äºŒå€¼åŒ–',
                    process: (ctx, width, height) => {
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, width, height);
                        grayscale(imageData);
                        const threshold = calculateOtsuThreshold(imageData);
                        binarize(imageData, threshold);
                        ctx.putImageData(imageData, 0, 0);
                        return ctx.getImageData(0, 0, width, height);
                    },
                    options: { inversionAttempts: "attemptBoth" }
                },
                
                // ç­–ç•¥ 7: ç¼©å°å›¾ç‰‡å°ºå¯¸ï¼ˆæé«˜å¤„ç†é€Ÿåº¦ï¼‰
                {
                    name: 'ç¼©å°å°ºå¯¸',
                    process: (ctx, width, height) => {
                        const scale = Math.min(1, 800 / Math.max(width, height));
                        const newWidth = Math.floor(width * scale);
                        const newHeight = Math.floor(height * scale);
                        canvas.width = newWidth;
                        canvas.height = newHeight;
                        ctx.drawImage(img, 0, 0, newWidth, newHeight);
                        const imageData = ctx.getImageData(0, 0, newWidth, newHeight);
                        enhanceContrast(imageData, 1.5);
                        return imageData;
                    },
                    options: { inversionAttempts: "attemptBoth" }
                }
            ];
            
            // ä¾æ¬¡å°è¯•æ¯ç§ç­–ç•¥
            for (let i = 0; i < strategies.length; i++) {
                const strategy = strategies[i];
                console.log(`ğŸ” å°è¯•ç­–ç•¥ ${i + 1}/${strategies.length}: ${strategy.name}...`);
                
                try {
                    // é‡ç½® canvas å°ºå¯¸
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // å¤„ç†å›¾åƒ
                    const imageData = strategy.process(ctx, canvas.width, canvas.height);
                    
                    // å°è¯•è¯†åˆ«
                    const code = jsQR(imageData.data, imageData.width, imageData.height, strategy.options);
                    
                    if (code && code.data) {
                        console.log(`âœ… è¯†åˆ«æˆåŠŸï¼ä½¿ç”¨ç­–ç•¥: ${strategy.name}`);
                        return {
                            data: code.data,
                            method: strategy.name,
                            location: code.location
                        };
                    }
                } catch (error) {
                    console.warn(`âš ï¸ ç­–ç•¥ ${strategy.name} å¤±è´¥:`, error);
                }
            }
            
            console.log('âŒ æ‰€æœ‰è¯†åˆ«ç­–ç•¥éƒ½å¤±è´¥äº†');
            return null;
        }
        
        /**
         * ç°åº¦åŒ–å¤„ç†
         */
        function grayscale(imageData) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                data[i] = gray;
                data[i + 1] = gray;
                data[i + 2] = gray;
            }
        }
        
        /**
         * å¢å¼ºå¯¹æ¯”åº¦
         */
        function enhanceContrast(imageData, factor) {
            const data = imageData.data;
            factor = factor || 1.5;
            const intercept = 128 * (1 - factor);
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, data[i] * factor + intercept));
                data[i + 1] = Math.min(255, Math.max(0, data[i + 1] * factor + intercept));
                data[i + 2] = Math.min(255, Math.max(0, data[i + 2] * factor + intercept));
            }
        }
        
        /**
         * äºŒå€¼åŒ–å¤„ç†
         */
        function binarize(imageData, threshold) {
            const data = imageData.data;
            threshold = threshold || 128;
            
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                const binary = gray > threshold ? 255 : 0;
                data[i] = binary;
                data[i + 1] = binary;
                data[i + 2] = binary;
            }
        }
        
        /**
         * è®¡ç®— Otsu é˜ˆå€¼ï¼ˆè‡ªé€‚åº”äºŒå€¼åŒ–ï¼‰
         */
        function calculateOtsuThreshold(imageData) {
            const data = imageData.data;
            const histogram = new Array(256).fill(0);
            const total = imageData.width * imageData.height;
            
            // æ„å»ºç°åº¦ç›´æ–¹å›¾
            for (let i = 0; i < data.length; i += 4) {
                const gray = Math.floor(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
                histogram[gray]++;
            }
            
            // è®¡ç®— Otsu é˜ˆå€¼
            let sum = 0;
            for (let i = 0; i < 256; i++) {
                sum += i * histogram[i];
            }
            
            let sumB = 0;
            let wB = 0;
            let wF = 0;
            let maxVariance = 0;
            let threshold = 0;
            
            for (let i = 0; i < 256; i++) {
                wB += histogram[i];
                if (wB === 0) continue;
                
                wF = total - wB;
                if (wF === 0) break;
                
                sumB += i * histogram[i];
                const mB = sumB / wB;
                const mF = (sum - sumB) / wF;
                const variance = wB * wF * (mB - mF) * (mB - mF);
                
                if (variance > maxVariance) {
                    maxVariance = variance;
                    threshold = i;
                }
            }
            
            console.log('ğŸ“Š Otsu é˜ˆå€¼:', threshold);
            return threshold;
        }
        
        /**
         * è¯»å–å›¾ç‰‡æ–‡ä»¶ä¸º Data URL
         */
        function readImageFile(file) {
            return new Promise((resolve, reject) => {
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    reject(new Error('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶'));
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ 10MBï¼‰
                if (file.size > 10 * 1024 * 1024) {
                    reject(new Error('å›¾ç‰‡å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº 10MB çš„å›¾ç‰‡'));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = function() {
                    reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
                };
                reader.readAsDataURL(file);
            });
        }

        // åœæ­¢äºŒç»´ç æ‰«æ
        function stopQRScanner() {
            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }

            const container = document.getElementById('qrScannerContainer');
            const scanButton = document.getElementById('scanButton');
            const stopButton = document.getElementById('stopScanButton');

            container.style.display = 'none';
            scanButton.style.display = 'inline-block';
            stopButton.style.display = 'none';

            if (qrScanner) {
                clearInterval(qrScanner);
                qrScanner = null;
            }
        }

        // åˆå§‹åŒ–äºŒç»´ç æ£€æµ‹
        function initQRDetection(video) {
            // æ£€æŸ¥ jsQR åº“æ˜¯å¦åŠ è½½
            if (typeof jsQR === 'undefined') {
                console.error('âŒ jsQR åº“æœªåŠ è½½ï¼æ— æ³•è¿›è¡ŒäºŒç»´ç è¯†åˆ«');
                alert('âš ï¸ äºŒç»´ç è¯†åˆ«åº“åŠ è½½å¤±è´¥\n\nè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
                stopQRScanner();
                return;
            }
            
            console.log('âœ… jsQR åº“å·²åŠ è½½ï¼Œç‰ˆæœ¬:', typeof jsQR);
            
            // ç­‰å¾…è§†é¢‘å‡†å¤‡å°±ç»ª
            video.addEventListener('canplay', function() {
                console.log('âœ… è§†é¢‘å·²å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹äºŒç»´ç æ£€æµ‹');
                console.log('è§†é¢‘å°ºå¯¸:', video.videoWidth, 'x', video.videoHeight);
                
                // åˆ›å»ºç”¨äºæ‰«æçš„ canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                // æ‰«æè®¡æ•°å™¨ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                let scanCount = 0;
                let lastScanTime = Date.now();
                
                // ä½¿ç”¨æ›´é¢‘ç¹çš„æ£€æµ‹é—´éš”
                qrScanner = setInterval(() => {
                    if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0 && video.videoHeight > 0) {
                        try {
                            scanCount++;
                            
                            // æ¯5ç§’è¾“å‡ºä¸€æ¬¡æ‰«æçŠ¶æ€
                            const now = Date.now();
                            if (now - lastScanTime > 5000) {
                                console.log(`ğŸ“· æ­£åœ¨æ‰«æ... (å·²æ‰«æ ${scanCount} æ¬¡)`);
                                lastScanTime = now;
                            }
                            
                            // è®¾ç½® canvas å°ºå¯¸ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡æˆ–å°ºå¯¸æ”¹å˜æ—¶è®¾ç½®ï¼‰
                            if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                                console.log('ğŸ“ Canvas å°ºå¯¸å·²è®¾ç½®:', canvas.width, 'x', canvas.height);
                            }
                            
                            // ç»˜åˆ¶å½“å‰å¸§åˆ° canvas
                            context.drawImage(video, 0, 0, canvas.width, canvas.height);
                            
                            // è·å–å›¾åƒæ•°æ®
                            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                            
                            // ä½¿ç”¨ jsQR è§£ç äºŒç»´ç 
                            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                                inversionAttempts: "dontInvert",
                            });
                            
                            if (code && code.data) {
                                console.log('ğŸ‰ æ£€æµ‹åˆ°äºŒç»´ç !');
                                console.log('äºŒç»´ç å†…å®¹:', code.data);
                                console.log('äºŒç»´ç ä½ç½®:', code.location);
                                processQRCodeResult(code.data);
                            }
                        } catch (e) {
                            console.error('âŒ äºŒç»´ç æ£€æµ‹è¿‡ç¨‹ä¸­å‡ºé”™:', e);
                        }
                    } else {
                        console.warn('âš ï¸ è§†é¢‘æœªå‡†å¤‡å°±ç»ª:', {
                            readyState: video.readyState,
                            videoWidth: video.videoWidth,
                            videoHeight: video.videoHeight
                        });
                    }
                }, 300); // æ¯300msæ£€æµ‹ä¸€æ¬¡ï¼Œæé«˜å“åº”é€Ÿåº¦
                
                console.log('âœ… äºŒç»´ç æ£€æµ‹å·²å¯åŠ¨');
            }, { once: true }); // åªç›‘å¬ä¸€æ¬¡ canplay äº‹ä»¶
        }

        // å¤„ç†äºŒç»´ç æ‰«æç»“æœ
        function processQRCodeResult(qrData) {
            console.log('æ‰«æåˆ°äºŒç»´ç :', qrData);
            
            // åœæ­¢æ‰«æ
            stopQRScanner();
            
            try {
                // è§£æäºŒç»´ç æ ¼å¼ï¼š{nfc_base_url}info?stuId={stu_id}
                const url = new URL(qrData);
                const stuId = url.searchParams.get('stuId');
                
                if (stuId) {
                    // è·³è½¬åˆ°ç”¨æˆ·ä¿¡æ¯é¡µé¢
                    window.location.href = `/info?stuId=${encodeURIComponent(stuId)}`;
                } else {
                    alert('æ— æ•ˆçš„äºŒç»´ç æ ¼å¼');
                }
            } catch (error) {
                console.error('è§£æäºŒç»´ç å¤±è´¥:', error);
                alert('æ— æ³•è¯†åˆ«çš„äºŒç»´ç æ ¼å¼');
            }
        }
    </script>
    
    <!-- å¼•å…¥ç»Ÿä¸€å¯¼èˆªæ ç»„ä»¶ -->
    <script src="/Pages/Common/js/navigation.js"></script>
</body>
</html>